var \u03c0=Math.PI,\u03c4=2*\u03c0;(function(a){for(var b in a)if(!window[b])throw"Error: MathBox requires "+a[b];})({THREE:"Three.js",tQuery:"tQuery.js (bundle)",ThreeBox:"ThreeBox.js",ThreeRTT:"ThreeRTT.js"});window.MathBox={};window.mathBox=function(a,b){a&&!(a instanceof Node)&&(b=a,a=null);return tQuery.createWorld(b).mathBox(a,b)};MathBox.getShader=function(a){var b=document.getElementById(a);return b&&(b.innerText||b.textContent)||a};Math.sign=function(a){return 0<a?1:0>a?-1:0};
MathBox.Attributes=function(){};
MathBox.Attributes.prototype={get:function(a){return void 0===a?this.__attributes||{}:!this.__attributes?void 0:this.__attributes[a]},set:function(a,b){function c(a,b){try{var c=b;if(void 0===e[a]){var k="validate"+a.charAt(0).toUpperCase()+a.slice(1);e[a]=i[k]||!1}b=e[a]?e[a](c):c;d[a]=b;f[a]=b}catch(l){throw"Exception setting '"+a+"' to '"+b+"': "+l;}}this.__attributes||(this.__attributes={});this.__validators||(this.__validators={});var d={},e=this.__validators,f=this.__attributes,i=this;void 0===
a||null===a||(a.constructor==String?c(a,b):_.each(a,function(a,b){c(b,a)}),this.emit("change",d))}};MicroEvent.mixin(MathBox.Attributes);MathBox.Attributes.mixin=function(a){_.each(["get","set","on","emit"],function(b){a.prototype[b]=MathBox.Attributes.prototype[b]})};MathBox.Animator=function(){this.active=[]};
MathBox.Animator.prototype={finalState:function(a){var b=_.extend({},a.get());a.__queue&&_.each(a.__queue,function(a,d){_.each(a,function(a){a.to&&(b[d]=a.to)})});return b},attach:function(a){if(!a.__queue){if(!a.__attributes)throw"Cannot attach to object without attributes";var b=this,c=a.set;a.set=function(a,e,f){if(!f){f=a;if(void 0===a||null===a)return;a.constructor==String&&(f={},f[a]=e);b.stop(this,f)}c.call(this,a,e)};a.__queue={};a.__animations=0}},hurry:function(a,b,c){c=c||300;_.each(b||
a.__queue,function(b,e){_.each(a.__queue[e],function(a){a instanceof MathBox.Animator.Delay&&(a.duration=0);a instanceof MathBox.Animator.Animation&&(a.duration=Math.min(a.duration,c))})}.bind(this))},stop:function(a,b){_.each(b||a.__queue,function(b,d){for(;a.__queue[d];)this.dequeue(a,d,!0)}.bind(this))},animate:function(a,b,c){c=_.extend({duration:300},c||{});this.attach(a);_.each(b,function(b,e){var f=a.__queue[e]=a.__queue[e]||[];if(c.delay){var i=new MathBox.Animator.Delay(a,e,c.delay);f.push(i);
0==a.__animations++&&this.active.push(a)}a.__validators[e]&&(b=a.__validators[e](b));i=new MathBox.Animator.Animation(a,e,b,c.duration,c.callback,c.ease);f.push(i);0==a.__animations++&&this.active.push(a)}.bind(this))},dequeue:function(a,b,c){var d=a.__queue[b];if(d){var e=d.shift();0==d.length&&delete a.__queue[b];c&&e.skip();0==--a.__animations&&this.active.splice(this.active.indexOf(a),1)}},update:function(){_.each(this.active,function(a){_.each(a.__queue,function c(d,e){var f=d[0];value=f.apply();
f.done()&&(this.dequeue(a,e),d[0]&&c.call(this,d,e))}.bind(this))}.bind(this))}};MathBox.Animator.Delay=function(a,b,c){this.object=a;this.key=b;this.duration=c;this.fraction=this.start=0};MathBox.Animator.Delay.prototype={init:function(){this.start=+new Date},apply:function(){this.start||this.init();this.fraction=0<this.duration?Math.min(1,(+new Date-this.start)/this.duration):1},skip:function(){this.duration=0},done:function(){return 1==this.fraction}};
MathBox.Animator.Animation=function(a,b,c,d,e,f){this.object=a;this.key=b;this.from=null;this.to=c;this.duration=d;this.fraction=this.start=0;this.callback=e;this.ease=f};
MathBox.Animator.Animation.prototype={init:function(){this.start=+new Date;null===this.from&&(this.from=this.object.get(this.key));void 0===this.from&&(this.from=0)},apply:function(){function a(c,d){void 0===d&&(d=c);if(d===c)return c;if(typeof c!=typeof d)throw console.log(b,e),"Data type mismatch between from/to values in animator. "+e+": "+c+" ("+c.constructor+"), "+d+"("+d.constructor+")";var f;switch(typeof d){default:case "string":throw"Unimplemented value type in animator. ("+typeof d+")";
case "function":return function(){return a(c.apply(this,arguments),d.apply(this,arguments))};case "boolean":return 0.5<i?d:c;case "number":return c+(d-c)*h;case "object":if(d.constructor==Array)return f=[],_.loop(c.length,function(b){f[b]=a(c[b],d[b])}),f;if(d.constructor==THREE.Matrix4){f=new THREE.Matrix4;for(var l=0;16>l;++l)f.elements[l]=c.elements[l]+(d.elements[l]-c.elements[l])*h;return f}if(d.constructor==THREE.Vector3)return f=new THREE.Vector3,f.x=c.x+(d.x-c.x)*h,f.y=c.y+(d.y-c.y)*h,f.z=
c.z+(d.z-c.z)*h,f;if(d.constructor==THREE.Color)return f=new THREE.Color,f.r=c.r+(d.r-c.r)*h,f.g=c.g+(d.g-c.g)*h,f.b=c.b+(d.b-c.b)*h,f;throw"Unimplemented value type in animator. "+typeof d+" ("+d.constructor+")";}}this.start||this.init();var b=this.object,c=this.from,d=this.to,e=this.key,f=this.ease,i;this.fraction=i=0<this.duration?Math.min(1,(+new Date-this.start)/(this.duration||1)):1;var h;switch(f){case "in":h=1-(1-i)*(1-i);break;case "out":h=i*i;break;default:h=0.5-0.5*Math.cos(i*\u03c0)}this.object.set(this.key,
a(c,d),!0)},skip:function(){this.duration=0;this.fraction=1;this.done()},done:function(){return 1==this.fraction?(this.object.set(this.key,this.to,!0),this.callback&&this.callback(),this.callback=null,!0):!1}};MathBox.Stage=function(a,b,c){this.options=a||{};this._world=b;this.cssOverlay=c;this.primitives=[];this.materials=new MathBox.Materials(this);this.animator=new MathBox.Animator;this.duration=0;b&&(this.cameraProxy=new MathBox.CameraProxy(b,this.options));this.viewport({});this.loadPrimitives()};
MathBox.Stage.prototype=new THREE.Object3D;MathBox.Attributes.mixin(MathBox.Stage);MicroEvent.mixin(MathBox.Stage);
MathBox.Stage.prototype=_.extend(MathBox.Stage.prototype,{update:function(){var a=this._viewport;this.animator.update();a.update(this);_.each(this.primitives,function(b){b.adjust(a);b=b.renderables();_.each(b,function(b){b.object&&b.adjust(a)})})},add:function(a,b){if(a instanceof THREE.Object3D)return THREE.Object3D.prototype.add.call(this,a);this._add(a);var b=this.animateOptions(b),c=a.style.get("opacity");b&&0<c&&(a.style.set("opacity",0),this.animator.animate(a.style,{opacity:c},b));return this},
remove:function(a,b){if(a instanceof THREE.Object3D)return THREE.Object3D.prototype.remove.call(this,a);"string"==typeof a&&_.each(this.select(a),function(a){this.remove(a,b)}.bind(this));var c=function(){this._remove(a)}.bind(this),b=this.animateOptions(b),d=a.style.get("opacity");b&&0<d?(b.callback=c,this.animator.animate(a.style,{opacity:0},b),a.removed=!0):c();return this},_add:function(a){var b=this.materials;-1==this.primitives.indexOf(a)&&(this.primitives.push(a),a.make(),a=a.renderables(),
_.each(a,function(a){a.make(b);a.object&&this.add(a.object)}.bind(this)))},_remove:function(a){if(-1!=this.primitives.indexOf(a)){this.primitives.splice(this.primitives.indexOf(a),1);var b=a.renderables();_.each(b,function(a){a.object&&this.remove(a.object);a.destroy()}.bind(this));a.destroy()}},select:function(a,b){var c=[];if("object"==typeof a)return a.constructor==Array?a:[a];var d=function(a){var c=[];if("*"==a)return c=this.primitives.slice(),c.push(this.viewport()),c.push(this.cameraProxy),
c;if(a==+a)return _.each(this.primitives,function(d){(b||!d.removed)&&d.get("sequence")==a&&c.push(d)}),c;var d=a.match(/^\s*#([a-zA-Z0-9_-]+)|([a-zA-Z0-9_-]+)?\s*$/);if(!d)return[];var h=d[2],g=d[1];if(g)_.each(this.primitives,function(a){(b||!a.removed)&&a.get("id")==g&&c.push(a)});else{if("camera"==h)return this.cameraProxy&&[this.cameraProxy]||[];if("viewport"==h)return[this.viewport()];h&&_.each(this.primitives,function(a){(b||!a.removed)&&a.type()==h&&c.push(a)})}return c}.bind(this),c=[],a=
(""+a).split(",");_.each(a,function(a){c=c.concat(d(a))});return c},set:function(a,b){b=this.extractStyle(b);_.each(this.select(a),function(a){a.set(b)})},get:function(a){var b=this.animator,a=this.select(a);if(1>a.length)return{};var c=a[0],a=b.finalState(c);c.style&&(b=b.finalState(c.style),a.style=b);return a},transition:function(a){return void 0!==a?(this.duration=a,this):this.duration},animateOptions:function(a,b){var c=this.duration;!0===a&&(a={});if(c||b||a&&(a.delay||a.duration))a=_.extend({duration:c||
300},a||{});if(a.delay||a.duration)return a},animate:function(a,b,c){var d=this.animator,b=this.extractStyle(b),c=this.animateOptions(c,!0);b.style&&(_.each(this.select(a),function(a){d.animate(a.style,b.style,c)}),b=_.extend({},b),delete b.style);_.each(this.select(a),function(a){d.animate(a,b,c)})},hurry:function(a,b,c){var d=this.animator;_.each(this.select(a,!0),function(a){d.hurry(a,b,c);a.style&&d.hurry(a.style,b,c)})},halt:function(a,b){var c=this.animator;_.each(this.select(a,!0),function(a){c.stop(a,
b);a.style&&c.stop(a.style,b)})},viewport:function(a){if(void 0!==a){if(!this._viewport||a.type&&a.type!=this.options.viewport.type){this._viewport=MathBox.Viewport.make(a);var a=this.primitives.slice(),b=this;_.each(a,function(){b._remove(this);b._add(this)})}else this._viewport.set(a);this.options.viewport=this._viewport.get();return this}return this._viewport},camera:function(a){_.each(this.select("camera"),function(b){b.set(a)});return this},start:function(){this._world&&this._world.start();return this},
stop:function(){this._world&&this._world.stop();return this},world:function(){return this._world},extractStyle:function(a){var b=MathBox.Style.prototype.defaults(),c=null;_.each(a,function(d,e){void 0!==b[e]&&(delete a[e],c=c||{},c[e]=d)});c&&(a.style=_.extend(a.style||{},c));return a},spawn:function(a,b,c){if(MathBox.Primitive.types[a])return this[a](b,c),this.primitives[this.primitives.length-1]},loadPrimitives:function(){_.each(MathBox.Primitive.types,function(a,b){this[b]=function(b,d){a.validateArgs&&
(b=a.validateArgs(b));var e=new a(this.extractStyle(b));this.add(e,d);return this}}.bind(this))}});MathBox.Materials=function(a){this.stage=a;this.list=[]};
MathBox.Materials.prototype={generic:function(a){var b=this.factory(),a=a||{},c=a.shaders||{};c.position?c.position(b,this):(this.position(b,a),a.absolute||(a.shaded?(b.group(),this.viewport(b),b.next(),this.viewport(b),b.next(),this.viewport(b),b.combine()):this.viewport(b)));return this.finalize(b,a)},position:function(a,b){b=b||{};a.snippet(b.shaded?"getPositionDUDV":"getPosition");b.shaded?a.group().snippet("mathTransform").next().snippet("mathTransform").next().snippet("mathTransform").combine():
a.snippet("mathTransform");return a},factory:function(){return new ShaderGraph.Factory},finalize:function(a,b){var b=b||{},c=b.shaders||{};b.shaded?a.snippet("projectToViewDUDV"):a.snippet("projectToView");c.material?c.material(a,this):a.material("vertexOutput",{points:"fragmentSolidPoint",mesh:b.shaded?"fragmentShaded":"fragmentSolid"}[b.type]||"fragmentSolid");c=a.end().compile();c=new THREE.ShaderMaterial({uniforms:c.uniforms,attributes:c.attributes,vertexShader:c.vertexShader,fragmentShader:c.fragmentShader});
b.wireframe&&(c.wireframe=!0);var d=this.apply.bind(this);c.applyUniforms=function(a){d(this,a,"uniforms")};c.applyAttributes=function(a){d(this,a,"attributes")};return c},apply:function(a,b,c){var d=a[c];_.each(b,function(a,b){var c=d[b];c&&(a instanceof THREE.Color&&(a.x=a.r,a.y=a.g,a.z=a.b),c.value=a,c.needsUpdate=!0)});"uniforms"==c&&(void 0!==b.lineWidth&&(a.wireframeLinewidth=a.linewidth=b.lineWidth),void 0!==b.opacity&&(a.transparent=1>b.opacity))},viewport:function(a,b){this.stage.viewport().shader(a,
b)}};MathBox.Ticks=function(a,b,c,d,e){var f=(b-a)/(c||10),d=d||1,c=d==\u03c0?2:10,i=d*Math.pow(c,Math.floor(Math.log(f/d)/Math.log(c))),d=_.map(c==\u03c0?[1]:[5,1,0.5],function(a){return i*a}),h=_.reduce(d,function(a,b){return Math.abs(b-f)<Math.abs(a-f)?b:a},i),e=+!e,a=(Math.ceil(a/h)+e)*h,b=(Math.floor(b/h)-e)*h,c=Math.ceil((b-a)/h)+1,g=[];_.loop(c,function(b){g.push(a+b*h)});return g};MathBox.TicksLog=function(){};
tQuery.World.register("mathBox",function(a,b){a=a||document.body;this.threeBox(a,b);var c=new Acko.CSS3DRenderer;a.appendChild(c.domElement);c.domElement.style.position="absolute";c.domElement.style.left=0;c.domElement.style.top=0;c.domElement.style.right=0;c.domElement.style.bottom=0;this.on("resize",function(a,b){c.setSize(a,b)});var d=new MathBox.Stage(b,this,c),e=function(){d.update()};this.tScene().add(d);this._renderer.setClearColorHex(16777215,1);d.unhook=function(){this.loop().unhookPreRender(e)};
this.loop().hookPreRender(e);if(!b.cameraControls){var f=this.tCamera();f.position.x=0;f.position.y=0;f.position.z=b.orbit;f.lookAt(new THREE.Vector3(0,0,0))}return d});MathBox.Director=function(a,b){this._stage=a;this.script=b;this.rollback={};this.lastCommand=this.step=0};
MathBox.Director.prototype={invert:function(a){var b=this._stage,c=[],d=a[0],e=a[1],f=a[2],i=a[3];switch(d){case "add":c.push(["remove",f.sequence||MathBox.Primitive.sequence+1]);break;case "remove":targets=b.select(e);_.each(targets,function(a){c.push(["add",a.type(),b.get(a)])});break;case "animate":case "set":targets=b.select(e),_.each(targets,function(a){var e=i&&Math.min(300,i.duration)||300;c.push([d,a.singleton||a.get("sequence"),b.get(a),{duration:e}])})}return c},apply:function(a,b,c){var d=
this._stage;_.each(a,function(a){var f=a[0]||"",i=a[1]||"",h=a[2]||{},g=a[3]||{};b&&(a=this.invert(a),a=[0,0].concat(a),Array.prototype.splice.apply(b,a));c&&(g&&(g=_.extend({},g),g.delay=0,g.duration=Math.min(300,g.duration)),h&&(h=_.extend({},h),h.delay=0,h.duration=Math.min(300,h.duration)));switch(f){case "add":d.spawn(i,h,g);break;case "remove":_.each(d.select(i),function(a){d.remove(a,h)});break;case "set":var f=d.select(i),j=h.constructor==Array;_.each(f,function(a,b){a.set(j?h[b]:h)});break;
case "animate":f=d.select(i),j=h.constructor==Array,_.each(f,function(a,b){d.animate(a,j?h[b]:h,g)})}}.bind(this));return this},insert:function(a){a[0].constructor!=Array&&(a=[a]);this.script.splice(this.step,0,a);this.forward();return this},go:function(a,b){if(this.script.length){for(;0>a;)a+=this.script.length+1;for(;a>=this.script.length+1;)a-=this.script.length+1;for(;a>this.step;)this.forward(b);for(;a<this.step;)this.back(b)}},skipping:function(){var a=+new Date,b=!1;500>a-this.lastCommand&&
(b=!0);this.stage().hurry("*");this.lastCommand=a;return b},forward:function(a){if(!(this.step>=this.script.length)){var b=this.script[this.step],c=this.rollback[this.step]=[];this.apply(b,c,a||this.skipping());this.step++;this.emit("go",this.step,1);return this}},back:function(a){if(!(0>=this.step))return this.step--,this.apply(this.rollback[this.step],null,a||this.skipping()),delete this.rollback[this.step],this.emit("go",this.step,-1),this},stage:function(){return this._stage}};
_.each(MathBox.Stage.prototype,function(a,b){MathBox.Director.prototype[b]||(MathBox.Director.prototype[b]=function(){var b=this.stage[a].apply(this.stage,arguments);return b===this.stage?this:b})});MicroEvent.mixin(MathBox.Director);MathBox.Style=function(a){var b=this.defaults(),a=_.extend(b,a||{});this.set(a)};
MathBox.Style.prototype={defaults:function(){return{color:new THREE.Color(3174640),opacity:1,lineWidth:2,pointSize:5,mathScale:new THREE.Vector3(1,1,1),mathRotation:new THREE.Vector3,mathPosition:new THREE.Vector3,worldScale:new THREE.Vector3(1,1,1),worldRotation:new THREE.Vector3,worldPosition:new THREE.Vector3,zIndex:0}},validateColor:function(a){if(a.constructor==Array){var b=new THREE.Color;return b.setRGB.apply(b,a)}return a.constructor==Number?new THREE.Color(a):a.constructor!=THREE.Color?this.get("color"):
a},validateMathScale:function(a){if(a.constructor==Array){var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("mathScale"):a},validateMathRotation:function(a){if(a.constructor==Array){var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("mathRotation"):a},validateMathPosition:function(a){if(a.constructor==Array){var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("mathPosition"):
a},validateWorldScale:function(a){if(a.constructor==Array){var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("worldScale"):a},validateWorldRotation:function(a){if(a.constructor==Array){var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("worldRotation"):a},validateWorldPosition:function(a){if(a.constructor==Array){var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("worldPosition"):
a}};MathBox.Attributes.mixin(MathBox.Style);MathBox.CameraProxy=function(a,b){this.set({orbit:b.orbit||3.5,phi:b.phi||\u03c4/4,theta:b.theta||0,lookAt:[0,0,0]});this.singleton="camera";var c=this.controls=a.getCameraControls()||ThreeBox.OrbitControls.bind(a.tCamera(),null,this.get());this.on("change",function(a){_.each(a,function(a,b){"lookAt"!=b&&(c[b]=a)});a.lookAt&&c.lookAt.set.apply(c.lookAt,a.lookAt);c.update()});c.update()};MathBox.Attributes.mixin(MathBox.CameraProxy);
MathBox.Primitive=function(a){if(null!==a){var b=this.defaults();a&&(a.style=_.extend(b.style,a.style||{}),a=_.extend(b,a||{}));a=a||b;this.set(a);this.renders=[];this.style=new MathBox.Style;this.style.set(this.get().style||{});this.on("change",function(a){void 0!==a.style&&this.style.set(a.style)}.bind(this));this.set("sequence",a.sequence||++MathBox.Primitive.sequence);this.set("id",a.id||this.sequence);this.init()}};MathBox.Primitive.sequence=0;MathBox.Primitive.types={};
MathBox.Primitive.prototype={defaults:function(){return{}},type:function(){return"primitive"},init:function(){},make:function(){},destroy:function(){},renderables:function(){return[]},adjust:function(){}};MathBox.Attributes.mixin(MathBox.Primitive);MicroEvent.mixin(MathBox.Primitive);MathBox.Curve=function(a){null!==a&&MathBox.Primitive.call(this,a)};
MathBox.Curve.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{n:64,domain:[0,1],data:null,expression:function(){return 0},live:!0,points:!1,line:!0,style:{}}},type:function(){return"curve"},renderables:function(){return[this.line,this.points]},adjust:function(){var a=this.get();this.line.show(a.line);this.points.show(a.points);a.live&&this.calculate()},make:function(){var a=this.get(),b=this.style,c=a.n,d=this.vertices=[];_.loop(c,function(){d.push(new THREE.Vector3)});
c=function(c){return new MathBox.Renderable.Mesh(d,{type:c,dynamic:a.live},b)};this.line=c("line");this.points=c("points");this.calculate()},calculate:function(){var a=this.vertices,b=this.get(),c=b.data,d=b.domain,e=b.n,f=d[0],i=(d[1]-f)/(e-1),h;_.loop(e,function(d){h=c&&void 0!==c[d]?c[d]:b.expression.call(this,f,d);h instanceof Array||(h=[f,h,0]);h=h.concat([0,0,0]);a[d].set.apply(a[d],h);f+=i}.bind(this))}});MathBox.Primitive.types.curve=MathBox.Curve;
MathBox.Bezier=function(a){MathBox.Curve.call(this,a)};
MathBox.Bezier.prototype=_.extend(new MathBox.Curve(null),{defaults:function(){return{n:64,domain:[0,1],data:null,order:3,expression:function(){return 0},live:!0,points:!1,line:!0,style:{}}},type:function(){return"bezier"},calculate:function(){var a=this.vertices,b=this.get(),c=b.domain,d=b.data,e=b.order,f=b.n;if(1>e||3<e)throw"Bezier curve order must be 1, 2 or 3.";var i=[],h;_.loop(e+1,function(a){h=d&&void 0!==d[a]?d[a]:b.expression.call(this,a,a);h instanceof Array||(h=[j,h,0]);h=h.concat([0,
0,0]);i.push(new THREE.Vector3(h[0],h[1],h[2]))}.bind(this));var g={bezierPoints:i},j=c[0],k=(c[1]-j)/(f-1);_.loop(f,function(b){a[b].set(j,0,0);j+=k});c={uniforms:g,shaders:{position:function(a,b){a.snippet("bezier"+e).snippet("mathTransform");b.viewport(a)}}};this.line.set(c);this.points.set(c)}});MathBox.Primitive.types.bezier=MathBox.Bezier;MathBox.Axis=function(a){null!==a&&MathBox.Primitive.call(this,a)};
MathBox.Axis.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{axis:0,offset:[0,0,0],n:2,ticks:10,tickBase:1,arrow:!0,size:0.07,style:{lineWidth:4,color:new THREE.Color(7368816)}}},renderables:function(){return[this.line,this.ticks,this.arrow]},type:function(){return"axis"},adjust:function(a){var b=this.get(),c=b.axis,d=b.offset,e=b.arrow,f=b.ticks,i=b.tickBase,b=b.n,h=this.points,g=this.tickPoints,j=this.tickSigns,k=[0,0,0],l=new THREE.Vector3,a=a.axis(c),m=a[0],a=a[1],q=
(a-m)/(b-1);l.set.apply(l,d);_.loop(b,function(a){k[c]=m+a*q;h[a].set.apply(h[a],k);h[a].addSelf(l)});this.arrow.show(e);this.ticks.show(!!f);if(f){d=MathBox.Ticks(m,a,f,i,!0);e=Math.floor(g.length/2);d.length>e&&(d=d.slice(0,e));var e=[0,0,0],n;e[2==c?0:1-c]=0.01*(a-m);this.epsilon.set.apply(this.epsilon,e);k=[0,0,0];_.each(d,function(a,b){b*=2;k[c]=a;g[b].set.apply(g[b],k);g[b].addSelf(l);j[b]=1;g[b+1].copy(g[b]);j[b+1]=-1;n=b+1});d=n+1;for(b=g.length;d<b;)g[d].copy(g[n]),j[d]=j[n],d++}window.ij=
!0},make:function(){var a=this.get(),b=a.n,c=a.ticks,d=this.style,e=this.points=[],f=this.tickPoints=[],i=this.tickSigns=[],h=this.epsilon=new THREE.Vector3;_.loop(b,function(){e.push(new THREE.Vector3)});_.loop(8*c,function(){f.push(new THREE.Vector3);i.push(1)});c={dynamic:!0,size:a.size,offset:0.5};a={dynamic:!0,size:0.2*a.size};this.line=new MathBox.Renderable.Mesh(e,{dynamic:!0,type:"line"},d);this.arrow=new MathBox.Renderable.ArrowHead(e[b-2],e[b-1],c,d);this.ticks=new MathBox.Renderable.Ticks(f,
i,h,a,d)}});MathBox.Axis.validateArgs=function(a){"number"==typeof a&&(a={axis:a});return a};MathBox.Primitive.types.axis=MathBox.Axis;MathBox.Grid=function(a){null!==a&&MathBox.Primitive.call(this,a)};
MathBox.Grid.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{axis:[0,1],offset:[0,0,0],show:[!0,!0],n:2,ticks:[10,10],tickBase:[1,1],style:{lineWidth:1,color:new THREE.Color(10526880)}}},type:function(){return"grid"},renderables:function(){return this.lines||[]},adjust:function(a){function b(a,b,c,d,e){var f=g.slice(),h=0,i=MathBox.Ticks(b.min,b.max,b.ticks,b.tickBase,!0);i.length>d&&(i=i.slice(0,d));_.each(i,function(d){f[b.axis]=d+g[b.axis];f[c.axis]=c.min+g[c.axis];_.loop(e-
1,function(){a[h].set.apply(a[h],f);h++;f[c.axis]+=c.inv;a[h].set.apply(a[h],f);h++})});d=Math.max(0,h-1);for(i=a.length;h<i;)a[h++].copy(a[d])}var c=this.get(),d=c.axis,e=c.ticks,f=c.tickBase,i=c.n,h=c.show,g=c.offset,c=this.points,j=this.limit,k=[];"number"==typeof i&&(i=[i,i]);_.each(d,function(b,c){var d=a.axis(b);k.push({axis:b,min:d[0],max:d[1],inv:(d[1]-d[0])/(i[c]-1),ticks:e[c],tickBase:f[c]})});this.lines[0].show(h[0]);this.lines[1].show(h[1]);h[0]&&b(c[0],k[1],k[0],j[0],i[0]);h[1]&&b(c[1],
k[0],k[1],j[1],i[1])},make:function(){var a=this.get(),b=a.ticks,c=a.n,d=this.points=[[],[]],a=this.style;"number"==typeof c&&(c=[c,c]);var e=this.limit=[0,0];_.each(b,function(a,b){b=1-b;e[b]=4*a;_.loop(2*e[b]*(c[b]-1),function(){d[b].push(new THREE.Vector3)})});this.lines=[];this.lines.push(new MathBox.Renderable.Mesh(d[0],{type:"line",strip:!1,dynamic:!0},a));this.lines.push(new MathBox.Renderable.Mesh(d[1],{type:"line",strip:!1,dynamic:!0},a))}});MathBox.Primitive.types.grid=MathBox.Grid;
MathBox.Vector=function(a){null!==a&&(MathBox.Primitive.call(this,a),this.render=[],this.line=this.points=this.vertices=null)};
MathBox.Vector.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{n:1,data:null,expression:function(){return 0},live:!0,style:{},size:0.07}},type:function(){return"vector"},renderables:function(){return this.render},adjust:function(a){this.get();this.calculate(a)},make:function(){var a=this.get(),b=this.style,c=a.n,d=this.vertices=[],e=this.points=[],f=this.render=[],i={dynamic:a.live,type:"line",strip:!1},h={size:a.size},g=0;_.loop(c,function(){d.push(new THREE.Vector3);d.push(new THREE.Vector3);
e.push(new THREE.Vector3);e.push(new THREE.Vector3);var a=new MathBox.Renderable.ArrowHead(e[g++],e[g++],h,b);f.push(a)});this.line=new MathBox.Renderable.Mesh(d,i,b);f.push(this.line);this.calculate()},calculate:function(a){var b=this.vertices,c=this.points,d=this.get(),e=d.data,f=d.n,i=d.size,h=new THREE.Vector3(1,1,1),g=new THREE.Vector3;if(a){var j=a.transform.elements,a=i/2/Math.abs(j[0]),k=i/2/Math.abs(j[5]),i=i/2/Math.abs(j[10]);h.set(a,k,i)}var l=0,m=0;_.loop(2*f,function(a){p=e&&void 0!==
e[a]?e[a]:d.expression.call(this,m,l);p instanceof Array||(p=[a,p,0]);p=p.concat([0,0,0]);c[a].set.apply(c[a],p);b[a].set.apply(b[a],p);if(1==a%2){g.sub(b[a],b[a-1]);g.x=Math.abs(g.x);g.y=Math.abs(g.y);g.z=Math.abs(g.z);var f=g.lengthManhattan(),f=1-g.dot(h)/f/g.length();g.sub(b[a],b[a-1]);g.multiplyScalar(f);b[a].add(b[a-1],g)}m=l?m+1:m;l=(l+1)%2}.bind(this))}});MathBox.Primitive.types.vector=MathBox.Vector;MathBox.Surface=function(a){null!==a&&MathBox.Primitive.call(this,a)};
MathBox.Surface.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{n:[64,64],domain:[[0,1],[0,1]],data:null,expression:function(){return 0},live:!0,points:!1,line:!1,mesh:!0,doubleSided:!0,flipSided:!1,shaded:!0,style:{}}},type:function(){return"surface"},renderables:function(){return[this.mesh,this.line,this.points]},adjust:function(){var a=this.get();this.mesh.show(a.mesh);this.line.show(a.line);this.points.show(a.points);a.live&&this.calculate()},make:function(){var a=this.get(),
b=this.style,c=a.n;"number"==typeof c&&(c=[c,c]);var d=this.geometry=new THREE.PlaneGeometry(2,2,c[0]-1,c[1]-1);this.vertices=d.vertices;this.mesh=new MathBox.Renderable.Mesh(d,{type:"mesh",doubleSided:a.doubleSided,flipSided:a.flipSided,shaded:a.shaded,dynamic:a.live},b);this.line=new MathBox.Renderable.Mesh(d,{type:"mesh",shaded:a.shaded,dynamic:a.live,wireframe:!0},b);this.points=new MathBox.Renderable.Mesh(d.vertices,{type:"points",dynamic:a.live},b);if(a.shaded){var e=this.tangents=[[],[]];_.loop(c[0]*
c[1],function(){e[0].push(new THREE.Vector3);e[1].push(new THREE.Vector3)})}this.calculate()},calculate:function(){var a=this.vertices,b=this.tangents,c=this.get(),d=c.data,e=c.domain,f=c.n;"number"==typeof f&&(f=[f,f]);var i=e[0][0],h=e[1][0],g=(e[0][1]-i)/(f[0]-1),j=(e[1][1]-h)/(f[1]-1),k,l=0;_.loop(f[1],function(b){i=e[0][0];_.loop(f[0],function(e){k=d&&void 0!==d[b]&&void 0!==d[b][e]?d[b][e]:c.expression.call(this,i,h,e,b,l);k instanceof Array||(k=[i,k,h]);k=k.concat([0,0,0]);a[l].set.apply(a[l],
k);i+=g;l++}.bind(this));h+=j}.bind(this));if(c.shaded){var l=0,h=e[1][0],m=f[0];_.loop(f[1],function(c){i=e[0][0];var d=c?c-1:0,k=Math.min(f[1]-1,c+1);_.loop(f[0],function(e){var h=e?e-1:0,j=Math.min(f[0]-1,e+1),r=a[e+c*m];j==e?b[0][l].sub(r,a[h+c*m],r).addSelf(r):b[0][l].copy(a[j+c*m]);k==c?b[1][l].sub(r,a[e+d*m]).addSelf(r):b[1][l].copy(a[e+k*m]);i+=g;l++});h+=j});this.line.set("attributes",{positionDU:b[0],positionDV:b[1]});this.mesh.set("attributes",{positionDU:b[0],positionDV:b[1]})}}});
MathBox.Primitive.types.surface=MathBox.Surface;MathBox.BezierSurface=function(a){this.matrixX=new THREE.Matrix4;this.matrixY=new THREE.Matrix4;this.matrixZ=new THREE.Matrix4;this.coefficients=new THREE.Matrix4(-1,3,-3,1,3,-6,3,0,-3,3,0,0,1,0,0,0);MathBox.Surface.call(this,a)};
MathBox.BezierSurface.prototype=_.extend(new MathBox.Surface(null),{defaults:function(){return{n:[64,64],domain:[[0,1],[0,1]],data:null,order:3,expression:function(){return 0},live:!0,points:!1,line:!1,mesh:!0,doubleSided:!0,flipSided:!1,shaded:!0,style:{}}},type:function(){return"bezierSurface"},calculate:function(){var a=this.vertices,b=this.get(),c=b.domain,d=b.data,e=b.order,f=b.shaded,i=b.n;"number"==typeof i&&(i=[i,i]);if(3!=e)throw"Bezier surface order must be 3.";var h=[],g;_.loop(e+1,function(a){_.loop(e+
1,function(c){g=d&&void 0!==d[a]&&void 0!==d[a][c]?d[c]:b.expression.call(this,c,a,c,a);g instanceof Array||(g=[c,g,a]);g=g.concat([0,0,0]);h.push(g)}.bind(this))}.bind(this));g=h;this.matrixX.set(g[0][0],g[1][0],g[2][0],g[3][0],g[4][0],g[5][0],g[6][0],g[7][0],g[8][0],g[9][0],g[10][0],g[11][0],g[12][0],g[13][0],g[14][0],g[15][0]);this.matrixY.set(g[0][1],g[1][1],g[2][1],g[3][1],g[4][1],g[5][1],g[6][1],g[7][1],g[8][1],g[9][1],g[10][1],g[11][1],g[12][1],g[13][1],g[14][1],g[15][1]);this.matrixZ.set(g[0][2],
g[1][2],g[2][2],g[3][2],g[4][2],g[5][2],g[6][2],g[7][2],g[8][2],g[9][2],g[10][2],g[11][2],g[12][2],g[13][2],g[14][2],g[15][2]);var j=this.coefficients;this.matrixX.multiplySelf(j).transpose().multiplySelf(j);this.matrixY.multiplySelf(j).transpose().multiplySelf(j);this.matrixZ.multiplySelf(j).transpose().multiplySelf(j);var j={bezierSurfaceX:this.matrixX,bezierSurfaceY:this.matrixY,bezierSurfaceZ:this.matrixZ},k=c[0][0],l=c[1][0],m=(c[0][1]-k)/(i[0]-1),q=(c[1][1]-l)/(i[1]-1),n=0;_.loop(i[1],function(){k=
c[0][0];_.loop(i[0],function(){a[n].set(k,l,0);k+=m;n++}.bind(this));l+=q}.bind(this));j={uniforms:j,shaders:{position:function(a,b){f?(a.snippet("bezierSurface"+e),a.group(),a.snippet("mathTransform"),b.viewport(a),a.next(),a.snippet("mathTransform"),b.viewport(a),a.next(),a.snippet("mathTransform"),b.viewport(a),a.combine()):(a.snippet("bezierSurface"+e).snippet("mathTransform"),b.viewport(a))}}};this.mesh.set(j);this.line.set(j);this.points.set(j)}});MathBox.Primitive.types.bezierSurface=MathBox.BezierSurface;
MathBox.Renderable=function(a,b){if(null!==a){this.id=++MathBox.Renderable.id;var c=this.defaults();a&&(a=_.extend(c,a||{}));this.set(a||c);this.geometry=this.material=this.object=null;this.visible=!0;this.style=b||new MathBox.Style;this.style.on("change",this.styleCallback=this.refresh.bind(this));this.on("change",this.uniformsCallback=this.refresh.bind(this));this.mathTransform=new THREE.Matrix4}};MathBox.Renderable.id=0;
MathBox.Renderable.prototype={defaults:function(){return{}},make:function(){},destroy:function(){},show:function(a){this.visible=void 0===a?!0:!!a;this.refresh()},composeTransform:function(a,b,c){var d=THREE.Matrix4.__m1,e=THREE.Matrix4.__m2;d.identity();d.setRotationFromEuler(b,this.object.eulerOrder);e.makeScale(c.x,c.y,c.z);this.mathTransform.multiply(d,e);b=this.mathTransform.elements;b[12]=a.x;b[13]=a.y;b[14]=a.z},refresh:function(){var a,b=this.style.get();this.object&&(this.object.position=
b.worldPosition,this.object.rotation=b.worldRotation,this.object.scale=b.worldScale,this.composeTransform(b.mathPosition,b.mathRotation,b.mathScale),this.object.visible=this.visible&&0<b.opacity,a=this.get(),this.object.doubleSided=a.doubleSided,this.object.flipSided=a.flipSided);this.material&&(this.material.applyUniforms(b),this.material.applyUniforms({mathTransform:this.mathTransform}),(a=this.get().uniforms)&&this.material.applyUniforms(a),(a=this.get().attributes)&&this.material.applyAttributes(a))},
adjust:function(a){this.material&&this.material.applyUniforms(a.uniforms())}};MathBox.Attributes.mixin(MathBox.Renderable);MathBox.Renderable.Mesh=function(a,b,c){this.points=a;MathBox.Renderable.call(this,b,c)};
MathBox.Renderable.Mesh.prototype=_.extend(new MathBox.Renderable(null),{defaults:function(){return{type:"points",doubleSided:!0,dynamic:!1,absolute:!1,strip:!0,shaders:{}}},make:function(a){var b=this.get(),c=b.type,d=b.strip,e={points:THREE.ParticleSystem,line:THREE.Line,mesh:THREE.Mesh}[c];if(!e)throw"Invalid Mesh type '"+c+"'";var a=this.material=a.generic(b),f;f=this.points;f instanceof Array?(f=this.geometry=new THREE.Geometry,f.vertices=this.points):f=this.geometry=f;f.dynamic=b.dynamic;switch(c){case "line":b=
new THREE.Line(f,a,d?THREE.LineStrip:THREE.LinePieces);break;default:b=new e(f,a)}this.object=b;this.refresh()},adjust:function(a){this.get().dynamic&&(this.geometry.verticesNeedUpdate=!0);MathBox.Renderable.prototype.adjust.call(this,a)}});MathBox.Renderable.ArrowHead=function(a,b,c,d){this.from=a;this.to=b;MathBox.Renderable.call(this,c,d)};
MathBox.Renderable.ArrowHead.prototype=_.extend(new MathBox.Renderable(null),{defaults:function(){return{offset:0,absolute:!0,size:0.1}},adjust:function(a){var b=this.get(),c=b.offset,d=this._from.copy(this.from),e=this._to.copy(this.to);a.to(d);a.to(e);d=this.diff.sub(d,e);if(0.001>d.length())this.object.visible=!1;else{this.object.visible=!0;d=d.normalize();this.normal.x=this.diff.y+0.1;this.normal.y=this.diff.z+0.2;this.normal.z=this.diff.x+0.3;this.normal.normalize();var f=this.bi.cross(this.diff,
this.normal),i=this.normal.cross(this.diff,this.bi),b=b.size,e=(new THREE.Matrix4(f.x,d.x,i.x,e.x,f.y,d.y,i.y,e.y,f.z,d.z,i.z,e.z,0,0,0,1)).scale(new THREE.Vector3(b,b,b));this.object.updateMatrix();this.object.matrix.multiplySelf(e);e.identity().setPosition({x:0,y:0.5-c,z:0});this.object.matrix.multiplySelf(e);this.object.matrixAutoUpdate=!1;this.object.matrixWorldNeedsUpdate=!0;MathBox.Renderable.prototype.adjust.call(this,a)}},make:function(a){var b=this.get(),a=this.material=a.generic(b);this._from=
new THREE.Vector3;this._to=new THREE.Vector3;this.diff=new THREE.Vector3;this.bi=new THREE.Vector3;this.normal=new THREE.Vector3(0,0,1);b=this.geometry=new THREE.CylinderGeometry(0.33,0,1,16,1);this.object=new THREE.Mesh(b,a);this.refresh()}});MathBox.Renderable.Ticks=function(a,b,c,d,e){this.points=a;this.signs=b;this.epsilon=c;MathBox.Renderable.call(this,d,e)};
MathBox.Renderable.Ticks.prototype=_.extend(new MathBox.Renderable(null),{defaults:function(){return{dynamic:!1,absolute:!1,size:0.1}},make:function(a){var b=this.get(),c=this.points,a=this.material=a.generic({type:"line",shaders:{position:function(a,c){c.position(a,b);a.snippet("tickVertexSplit");a.group();c.viewport(a);a.next();c.viewport(a);a.combine();a.snippet("tickVertexJoin")}}}),d=this.geometry=new THREE.Geometry;d.vertices=c;this.object=new THREE.Line(d,a,THREE.LinePieces);this.refresh()},
adjust:function(a){var b=this.get();this.material&&this.material.applyAttributes({tickSign:this.signs});this.material&&this.material.applyUniforms({tickEpsilon:this.epsilon,tickSize:b.size});b.dynamic&&(this.material.attributes.tickSign.needsUpdate=!0,this.geometry.verticesNeedUpdate=!0);MathBox.Renderable.prototype.adjust.call(this,a)}});MathBox.Viewport=function(a){if(null!==a){var b=this.defaults(),a=_.extend(b,a||{});this.set(a);this.singleton="viewport";this._uniforms={}}};
MathBox.Viewport.prototype={defaults:function(){return{type:"none",rotation:[0,0,0],position:[0,0,0]}},uniforms:function(){return this._uniforms},axis:function(){return[0,1]},to:function(){},from:function(){},update:function(a){var b=this.get();_.each(["position","rotation"],function(c){a[c].set.apply(a[c],b[c])})},shader:function(a){a.snippet("mathToWorld")},validateRotation:function(a){return a.constructor==Array?(a=a.concat([0,0,0]),a.slice(0,3)):this.get("rotation")},validatePosition:function(a){return a.constructor==
Array?(a=a.concat([0,0,0]),a.slice(0,3)):this.get("position")}};MathBox.Attributes.mixin(MathBox.Viewport,"type");MathBox.Viewport.types={};MathBox.Viewport.make=function(a){return new (MathBox.Viewport.types[a.type]||MathBox.Viewport.types.cartesian||MathBox.Viewport)(a)};
MathBox.ViewportCartesian=function(a){if(null!==a){var b=MathBox.Viewport;b.call(this,a);this.super=b.prototype;this.transform=new THREE.Matrix4;this.inverse=new THREE.Matrix4;_.extend(this._uniforms,{viewportTransform:this.transform,viewportInverse:this.inverse})}};
MathBox.ViewportCartesian.prototype=_.extend(new MathBox.Viewport(null),{defaults:function(){return{type:"cartesian",range:[[-1,1],[-1,1],[-1,1]],scale:[1,1,1],rotation:[0,0,0],position:[0,0,0]}},to:function(a){this.transform.multiplyVector3(a)},from:function(a){this.inverse.multiplyVector3(a)},axis:function(a){var b=this.get().range[a],a=b[0],c=b[1],b=Math.min(a,c),a=Math.max(a,c);return[b,a]},update:function(a){var b=this.get(),c=b.range,d=b.scale,b=c[0][0],e=c[1][0],f=c[2][0],i=c[0][1]-b,h=c[1][1]-
e,c=c[2][1]-f,g=d[0],j=d[1],d=d[2],k=[i/(2*g),0,0,b+i/2,0,h/(2*j),0,e+h/2,0,0,c/(2*d),f+c/2,0,0,0,1];this.transform.set.apply(this.transform,[2*g/i,0,0,-(2*b+i)*g/i,0,2*j/h,0,-(2*e+h)*j/h,0,0,2*d/c,-(2*f+c)*d/c,0,0,0,1]);this.inverse.set.apply(this.inverse,k);MathBox.Viewport.prototype.update.call(this,a)},validateRange:function(a){for(var a=a||[],b=0;3>b;++b){a[b]=a[b]||[];for(var c=0;2>c;++c)a[b][c]=void 0!==a[b][c]?a[b][c]:2*c-1}return a},validateScale:function(a){for(var a=a||[],b=0;3>b;++b)a[b]=
a[b]||1;return a}});MathBox.Attributes.mixin(MathBox.Viewport);MathBox.Viewport.types.cartesian=MathBox.ViewportCartesian;MathBox.ViewportPolar=function(a){var b=MathBox.ViewportCartesian;b.call(this,a);this.super=b.prototype;_.extend(this._uniforms,{polarAlpha:0,polarAspect:1,polarPower:1,polarFold:1,polarFocus:1})};
MathBox.ViewportPolar.prototype=_.extend(new MathBox.ViewportCartesian(null),{defaults:function(){return{type:"polar",range:[[-1,1],[-1,1],[-1,1]],polar:1,fold:1,power:1,aspect:1,scale:[1,1,1],rotation:[0,0,0],position:[0,0,0]}},to:function(a){var b=this._uniforms.polarAspect,c=this._uniforms.polarFocus,d=this._uniforms.polarAlpha,e=this._uniforms.polarPower;a.x*=this._uniforms.polarFold;a.y=Math.sign(a.y)*Math.pow(Math.abs(a.y),e);1E-4<d&&(e=c+a.y*b,d*=a.x,a.x=Math.sin(d)*e,a.y=(Math.cos(d)*e-c)/
b);this.transform.multiplyVector3(a)},from:function(a){var b=this._uniforms.polarAspect,c=this._uniforms.polarFocus,d=this._uniforms.polarAlpha,e=this._uniforms.polarPower;this.inverse.multiplyVector3(a);if(1E-4<d){var f=a.x,i=a.y*b+c,h=Math.sqrt(f*f+i*i);theta=Math.atan2(i,f);a.x=theta/d;a.y=(h-c)/b}a.x/=options.fold;a.y=Math.sign(a.y)*Math.pow(Math.abs(a.y),1/e)},axis:function(a){var b=this.super.axis.call(this,a);min=b[0];max=b[1];alpha=this._uniforms.polarAlpha;aspect=this._uniforms.polarAspect;
focus=this._uniforms.polarFocus;1==a&&0<alpha&&(max=Math.max(Math.abs(max),Math.abs(min)),min=Math.max(-focus/aspect,min));return[min,max]},update:function(a){var b=this.get(),c=b.range,d=b.scale,e=b.polar,f=b.fold,b=b.power,i=1,h=c[0][0],g=c[1][0],j=c[2][0],k=c[0][1]-h,l=c[1][1]-g,c=c[2][1]-j,m=d[0],q=d[1],d=d[2],n=k+(l-k)*e,i=n/m/(l/q),s=[n/(2*m),0,0,h+k/2,0,l/(2*q),0,g+l/2,0,0,c/(2*d),j+c/2,0,0,0,1];this.transform.set.apply(this.transform,[2*m/n,0,0,-(2*h+k)*m/k,0,2*q/l,0,-(2*g+l)*q/l,0,0,2*d/
c,-(2*j+c)*d/c,0,0,0,1]);this.inverse.set.apply(this.inverse,s);this._uniforms.polarAlpha=e;this._uniforms.polarAspect=i;this._uniforms.polarFold=f;this._uniforms.polarPower=b;this._uniforms.polarFocus=0<e?1/e-1:0;MathBox.Viewport.prototype.update.call(this,a)},shader:function(a){a.snippet("polarPower").snippet("cartesianToPolar").snippet("mathToWorld")},validatePolar:function(a){return Math.max(0,Math.min(1,+a||0))}});MathBox.Attributes.mixin(MathBox.Viewport);MathBox.Viewport.types.polar=MathBox.ViewportPolar;
MathBox.ViewportSphere=function(a){var b=MathBox.ViewportCartesian;b.call(this,a);this.super=b.prototype;_.extend(this._uniforms,{sphereAlpha:0,sphereAspectX:1,sphereAspectY:1,sphereYScale:1,sphereFocus:1})};
MathBox.ViewportSphere.prototype=_.extend(new MathBox.ViewportCartesian(null),{defaults:function(){return{type:"sphere",range:[[-1,1],[-1,1],[-1,1]],sphere:1,aspect:1,scale:[1,1,1],rotation:[0,0,0],position:[0,0,0]}},to:function(a){var b=this._uniforms.sphereAspectX,c=this._uniforms.sphereAspectY,d=this._uniforms.sphereYScale,e=this._uniforms.sphereFocus,f=this._uniforms.sphereAlpha;if(1E-4<f){var i=e+a.z*b,h=a.x*f,d=a.y*f/c*d,f=Math.cos(d)*i;a.x=Math.sin(h)*f;a.y=Math.sin(d)*i*c;a.z=(Math.cos(h)*
f-e)/b}this.transform.multiplyVector3(a)},from:function(a){var b=this._uniforms.sphereAspectX,c=this._uniforms.sphereAspectY,d=this._uniforms.sphereYScale,e=this._uniforms.sphereFocus,f=this._uniforms.sphereAlpha;this.inverse.multiplyVector3(a);if(1E-4<f){var i=a.x,h=a.y/c,g=a.z*b+e,j=Math.sqrt(i*i+h*h+g*g);theta=Math.atan2(h,Math.sqrt(i*i+h*h));phi=Math.atan2(i,g);a.x=theta/f;a.y=phi/f*c/d;a.z=(j-e)/b}},axis:function(a){var b=this.super.axis.call(this,a);min=b[0];max=b[1];alpha=this._uniforms.sphereAlpha;
beta=this._uniforms.sphereBeta;aspectX=this._uniforms.sphereAspectX;aspectY=this._uniforms.sphereAspectY;focus=this._uniforms.sphereFocus;2==a&&0<alpha&&(max=Math.max(Math.abs(max),Math.abs(min)),min=Math.max(-focus/aspectX,min));return[min,max]},update:function(a){var b=this.get(),c=b.range,d=b.scale,b=b.sphere,e=0<b?1/b-1:0,f=c[0][0],i=c[1][0],h=c[2][0],g=c[0][1]-f,j=c[1][1]-i,c=c[2][1]-h,k=d[0],l=d[1],d=d[2],m=g+(c-g)*b,q=j+(c-j)*b,n=c/d;aspectX=m/k/n;aspectY=q/l/n/aspectX;aspectZ=2*(j/g*k/l);
yScale=Math.min(aspectY/b,1+(aspectZ-1)*b);n=[m/(2*k),0,0,f+g/2,0,q/(2*l),0,i+j/2,0,0,c/(2*d),h+c/2,0,0,0,1];this.transform.set.apply(this.transform,[2*k/m,0,0,-(2*f+g)*k/g,0,2*l/q,0,-(2*i+j)*l/j,0,0,2*d/c,-(2*h+c)*d/c,0,0,0,1]);this.inverse.set.apply(this.inverse,n);this._uniforms.sphereAlpha=b;this._uniforms.sphereAspectX=aspectX;this._uniforms.sphereAspectY=aspectY;this._uniforms.sphereYScale=yScale;this._uniforms.sphereFocus=e;MathBox.Viewport.prototype.update.call(this,a)},shader:function(a){a.snippet("cartesianToSphere").snippet("mathToWorld")},
validateSphere:function(a){return Math.max(0,Math.min(1,+a||0))}});MathBox.Attributes.mixin(MathBox.Viewport);MathBox.Viewport.types.sphere=MathBox.ViewportSphere;

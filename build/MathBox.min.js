window.Acko=window.Acko||{};
(function(a){function b(a){return 1E-6>Math.abs(a)?0:a}var c=a.CSS3DRenderer=function(a){function f(f){var e=0.5/Math.tan(f.fov*\u03c0/360)*h,q="";f.position.length();f.matrixWorldInverse.getInverse(f.matrixWorld);q+="translate3d(0,0,"+b(e)+"px) ";q+=c.toCSSMatrix(f.matrixWorldInverse,!0);f=q+=" translate3d("+g+"px,"+i+"px,0)";j.style.WebkitTransform=f;j.style.MozTransform=f;j.style.OTransform=f;j.style.msTransform=f;j.style.transform=f;!1!==a.perspective&&(f=a.perspective||c.perspective||k,e+="px",
f.style.WebkitPerspective=e,f.style.MozPerspective=e,f.style.OPerspective=e,f.style.msPerspective=e,f.style.terspective=e)}var a=a||{},e,h,g,i;new THREE.Matrix4;new THREE.Matrix4;var k=document.createElement("div"),j=document.createElement("div");k.className="css3d-renderer";j.className="css3d-camera";k.appendChild(j);this.domElement=k;this.setSize=function(a,b){e=a;h=b;g=e/2;i=h/2};this.render=function(a,b){var d,g,e;for(a.updateMatrixWorld();a.__objectsAdded.length;)d=a.__objectsAdded[0],g=d.domrender,
"undefined"==typeof g&&(g=d.domrender=c.Renderable.factory(d)),g&&g.insertInto(j),a.__objectsAdded.splice(0,1);for(;a.__objectsRemoved.length;)(d=a.__objectsRemoved[0].domrender)&&d.remove(),a.__objectsRemoved.splice(0,1);f(b);d=a.objects;e=0;for(ol=d.length;e<ol;e++)if(g=d[e],(domrender=g.domrender)&&domrender.needsRender)g.visible?domrender.visible||domrender.show():domrender.visible&&domrender.hide(),domrender.update(),domrender.needsRender=!1};this.updateCamera=f};c.getTemplate=function(a){return(a=
document.getElementById("template-"+a))&&a.innerText};c.toCSSColor=function(a){var b=a.color;return"rgba("+255*b.r+","+255*b.g+","+255*b.b+","+a.opacity+")"};c.toCSSMatrix=function(a,c){var e;e=c?[a.n11,-a.n21,a.n31,a.n41,a.n12,-a.n22,a.n32,a.n42,a.n13,-a.n23,a.n33,a.n43,a.n14,-a.n24,a.n34,a.n44]:[a.n11,a.n21,a.n31,a.n41,a.n12,a.n22,a.n32,a.n42,a.n13,a.n23,a.n33,a.n43,a.n14,a.n24,a.n34,a.n44];for(var h in e)e[h]=b(e[h]);return"matrix3d("+e.join(",")+")"};c.Renderable=function(a){this.object=a;this.visible=
this.needsRender=!0;this.editable=this.tagged=this.selected=!1;this.$element=null;this.init()};c.Renderable.prototype={$markup:function(){return $("<div>")},init:function(){this.$element=this.$markup()},insertInto:function(a){$(a).append(this.$element)},remove:function(){this.$element.remove()},update:function(){},show:function(){this.$element.show();this.visible=!0},hide:function(){this.$element.hide();this.visible=!1}};c.HTML=function(a){this.object=null;this.type="CSSHTML";this.supr(a);this.editable=
!0;this.state=!1};c.HTML.v=new THREE.Vector4;c.HTML.prototype=$.extend(new c.Renderable,{$markup:function(){var a=$("<div>");a.css({position:"absolute",WebkitTransformOrigin:"0% 0%",MozTransformOrigin:"0% 0%",OTransformOrigin:"0% 0%",msTransformOrigin:"0% 0%",transformOrigin:"0% 0%"});""!=this.object.name&&a.append(c.getTemplate(this.object.name));a.addClass("css3d-"+this.object.name);return a},transform:function(a){return""+c.toCSSMatrix(a)},update:function(){var a=this.object,b=a.matrixWorld,a=
c.toCSSColor(a.material),b=this.transform(b);this.$element.css({color:a,WebkitTransform:b,MozTransform:b,OTransform:b,msTransform:b,transform:b});this.selected^this.state&&(this.$element.css({opacity:this.selected?0.75:1}),this.state=this.selected)}});c.HTML.prototype.supr=c.Renderable;c.Plane=function(a){this.object=null;this.type="CSSPlane";this.supr(a);this.editable=!0;this.state=!1};c.Plane.v=new THREE.Vector4;c.Plane.prototype=$.extend(new c.Renderable,{$markup:function(){var a=$("<div>");a.css({position:"absolute",
width:"1px",height:"1px",WebkitTransformOrigin:"0% 0%",MozTransformOrigin:"0% 0%",OTransformOrigin:"0% 0%",msTransformOrigin:"0% 0%",transformOrigin:"0% 0%"});a[0].editRender=this;return a},transform:function(a,f,e){var h,g,i=c.Plane.v;i.set(e.n11,e.n21,e.n31,e.n41);h=a*i.length();g=(h+0.25)/h;i.set(e.n12,e.n22,e.n32,e.n42);h=a*i.length();h=(h+0.25)/h;return[c.toCSSMatrix(e),"matrix3d(1,0,0,0, 0,1,0,0, 0,0,-1,0, 0,0,0,1) rotateY(180deg)","scale3d("+b(g*a)+","+b(h*f)+",1)","translate3d("+b(-0.5*g)+
"px,"+b(-0.5*h)+"px,0)"].join(" ")},update:function(){var a=this.object,b=a.matrixWorld,e=a.geometry.vertices,h=2*e[1].position.x,e=2*e[1].position.y,a=c.toCSSColor(a.material);this.tagged&&(a="rgba(30,90,170,.75)");b=this.transform(h,e,b);this.$element.css({background:a,WebkitTransform:b,MozTransform:b,OTransform:b,msTransform:b,transform:b,WebkitBackfaceVisibility:"hidden",MozBackfaceVisibility:"hidden",OBackfaceVisibility:"hidden",msBackfaceVisibility:"hidden",backfaceVisibility:"hidden"});this.selected^
this.state&&(this.$element.css({opacity:this.selected?0.75:1}),this.state=this.selected)}});c.Plane.prototype.supr=c.Renderable;c.Line=function(a){this.object=null;this.type="CSSLine";this.supr(a);this.$lines=[];this.lineCount=0};c.Line.diff=new THREE.Vector3;c.Line.prototype=$.extend(new c.Renderable,{$line:function(){var a=$("<div>");a.css({position:"absolute",width:"1px",height:"1px",WebkitTransformOrigin:"0% 0%",MozTransformOrigin:"0% 0%",OTransformOrigin:"0% 0%",msTransformOrigin:"0% 0%",transformOrigin:"0% 0%"});
return a},getNextLine:function(){var a=this.$lines[this.lineCount];a||(this.$lines[this.lineCount]=a=this.$line(),this.$element.append(a));this.lineCount++;return a},newPass:function(){this.lineCount=0},garbageCollect:function(){for(;this.$lines.length>this.lineCount;)this.$lines.pop().remove()},transform:function(a,f,e,h){var g=c.Line.diff;g.sub(f,a);var f=Math.atan2(g.z,g.x),i=Math.atan2(g.y,Math.sqrt(g.z*g.z+g.x*g.x));return["translate3d("+b(a.x)+"px,"+b(a.y)+"px,"+b(a.z)+"px)","rotateY("+b(-f)+
"rad)","rotateZ("+b(i)+"rad)","rotateX("+b(h)+"deg)","scale3d("+b(g.length())+","+b(e)+",1)","translate3d(0,-.5px,0)"].join(" ")},update:function(){var a=this.object,b,e;b=a.material;var h=a.geometry.vertices;this.newPass();var g=c.toCSSColor(b),i=h[0].position,k,j;b=1;for(vl=h.length;b<vl;b++)k=i,i=h[b].position,j=this.transform(k,i,a.material.linewidth,0),e=this.getNextLine(),e.css({backgroundColor:g,WebkitTransform:j,MozTransform:j,OTransform:j,msTransform:j,transform:j}),j=this.transform(k,i,
a.material.linewidth,90),e=this.getNextLine(),e.css({backgroundColor:g,WebkitTransform:j,MozTransform:j,OTransform:j,msTransform:j,transform:j});this.garbageCollect()}});c.Line.prototype.supr=c.Renderable;c.Renderable.factory=function(a){return a instanceof THREE.Mesh&&a.geometry instanceof THREE.PlaneGeometry?""!=a.name?new c.HTML(a):new c.Plane(a):a instanceof THREE.Line?new c.Line(a):!1};c.perspective=null})(window.Acko);var MicroEvent=function(){};
MicroEvent.prototype={bind:function(a,b){this._events=this._events||{};this._events[a]=this._events[a]||[];this._events[a].push(b)},unbind:function(a,b){this._events=this._events||{};!1!==a in this._events&&this._events[a].splice(this._events[a].indexOf(b),1)},trigger:function(a){this._events=this._events||{};if(!1!==a in this._events)for(var b=0;b<this._events[a].length;b++)this._events[a][b].apply(this,Array.prototype.slice.call(arguments,1))}};
MicroEvent.mixin=function(a){for(var b=["bind","unbind","trigger"],c=0;c<b.length;c++)a.prototype[b[c]]=MicroEvent.prototype[b[c]]};"undefined"!==typeof module&&"exports"in module&&(module.exports=MicroEvent);
function microAjax(a,b,c){this.bindFunction=function(a,b){return function(){return a.apply(b,[b])}};this.stateChange=function(){4==this.request.readyState&&this.callbackFunction(this.request.responseText)};this.getRequest=function(){return window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):window.XMLHttpRequest?new XMLHttpRequest:!1};this.postBody=c||"";this.callbackFunction=b;this.url=a;if(this.request=this.getRequest())b=this.request,b.onreadystatechange=this.bindFunction(this.stateChange,
this),""!==this.postBody?(b.open("POST",a,!0),b.setRequestHeader("X-Requested-With","XMLHttpRequest"),b.setRequestHeader("Content-type","application/x-www-form-urlencoded"),b.setRequestHeader("Connection","close")):b.open("GET",a,!0),b.send(this.postBody)}var \u03c0=Math.PI,\u03c4=2*\u03c0;(function(a){for(var b in a)if(!window[b])throw"Error: ThreeBox requires "+a[b];})({THREE:"Three.js",tQuery:"tQuery.js (bundle)"});window.ThreeBox={};
window.threeBox=function(a,b){a&&!(a instanceof Node)&&(b=a,a=null);return tQuery.createWorld(b).threeBox(a,b)};MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};MicroEvent.mixin=function(a){for(var b=["bind","unbind","trigger","on","emit"],c=0;c<b.length;c++)a.prototype[b[c]]=MicroEvent.prototype[b[c]]};tQuery.World.prototype.on=tQuery.World.prototype.addEventListener;
tQuery.World.prototype.emit=tQuery.World.prototype.dispatchEvent;tQuery.World.register("threeBox",function(a,b){a&&!(a instanceof Node)&&(b=a,a=null);var c=a=a||document.body;a==document.body?(c.style.margin=0,c.style.padding=0,c.style.overflow="hidden"):(getComputedStyle(a),"static"==a.position&&(a.position="relative"));this.appendTo(c);this.addThreeBox(a,b||{});return this});
tQuery.World.register("addThreeBox",function(a,b){console.assert(!0!==this.hasThreeBox());b=tQuery.extend(b,{cameraControls:!1,cursor:!0,controlClass:ThreeBox.OrbitControls,elementResize:!0,fullscreen:!0,screenshot:!0,stats:!0,scale:1});this.tRenderer().domElement.style.display="block";var c={};tQuery.data(this,"_threeBoxContext",c);var d=this.tCamera(),f=this.tRenderer();b.stats&&(c.stats=new Stats,c.stats.domElement.style.position="absolute",c.stats.domElement.style.left="10px",c.stats.domElement.style.top=
"10px",a&&a.appendChild(c.stats.domElement),c.loopStats=function(){c.stats.update()},this.loop().hook(c.loopStats));if(b.cameraControls){var e=this.loop(),h=this.render.bind(this);c.cameraControls=ThreeBox.OrbitControls.bind(d,a,b).on("change",function(){e._timerId||h()});this.setCameraControls(c.cameraControls)}b.elementResize&&(c.elementResize=ThreeBox.ElementResize.bind(f,d,a,b).on("resize",function(a,b){this._opts.renderW=a;this._opts.renderH=b;this.emit("resize",a,b)}.bind(this)));null!==b.cursor&&
(c.cursor=ThreeBox.Cursor.bind(a,b));b.screenshot&&(c.screenshot=THREEx.Screenshot.bindKey(f));b.fullscreen&&THREEx.FullScreen.available()&&(c.fullscreen=THREEx.FullScreen.bindKey());c._$onDestroy=this.bind("destroy",function(){!1!==this.hasThreeBox()&&this.removeThreeBox()});return this});tQuery.World.register("hasThreeBox",function(){return void 0===tQuery.data(this,"_threeBoxContext")?!1:!0});
tQuery.World.register("removeThreeBox",function(){var a=tQuery.data(this,"_threeBoxContext");if(void 0===a)return this;tQuery.removeData(this,"_threeBoxContext");this.unbind("destroy",this._$onDestroy);a.stats&&(document.body.removeChild(a.stats.domElement),this.loop().unhook(a.loopStats));a.cameraControls&&this.removeCameraControls()&&a.cameraControls.stop();a.elementResize&&a.elementResize.unbind();a.cursor&&a.cursor.unbind();a.screenshot&&a.screenshot.unbind();a.fullscreen&&a.fullscreen.unbind()});
ThreeBox.ElementResize=function(a,b,c,d){this.scale=d.scale||1;this.orbit=d.orbit;d=this.callback=function(){var d=Math.floor(c.offsetWidth),e=Math.floor(c.offsetHeight);a.domElement.style.position="absolute";a.domElement.style.width=d+"px";a.domElement.style.height=e+"px";var h=Math.floor(d/this.scale),g=Math.floor(e/this.scale);a.setSize(h,g);b.aspect=d/e;b instanceof THREE.OrthographicCamera&&(b.top=this.orbit/2,b.bottom=-b.top,b.left=-b.top*b.aspect,b.right=-b.bottom*b.aspect);b.updateProjectionMatrix();
this.emit("resize",h,g)}.bind(this);window.addEventListener("resize",d,!1);c.addEventListener("resize",d,!1);setTimeout(d,0)};ThreeBox.ElementResize.bind=function(a,b,c,d){return new ThreeBox.ElementResize(a,b,c,d)};ThreeBox.ElementResize.prototype.scale=function(a){this.scale=a};ThreeBox.ElementResize.prototype.unbind=function(){window.removeEventListener("resize",callback);domElement.removeEventListener("resize",callback)};MicroEvent.mixin(ThreeBox.ElementResize);
ThreeBox.OrbitControls=function(a,b,c){this.element=b;this.camera=a;this.options=tQuery.extend(c,{phi:\u03c4/4,theta:0.3,orbit:2,lookAt:[0,0,0],speed:2});this.init();this.start();this.update()};
ThreeBox.OrbitControls.prototype={init:function(){this.width=this.element&&this.element.offsetWidth;this.height=this.element&&this.element.offsetHeight;this.phi=this.options.phi;this.theta=this.options.theta;this.orbit=this.options.orbit;this.speed=this.options.speed;this.lookAt=new THREE.Vector3;this.lookAt.set.apply(this.lookAt,this.options.lookAt||[])},start:function(){var a=this;this._mouseDown=function(a){this.drag=!0;this.lastHover=this.origin={x:a.pageX,y:a.pageY};a.preventDefault()}.bind(this);
this._mouseUp=function(){this.drag=!1}.bind(this);this._mouseMove=function(){if(a.drag){var b={x:event.pageX-a.origin.x,y:event.pageY-a.origin.y},c={x:event.pageX-a.lastHover.x,y:event.pageY-a.lastHover.y};a.lastHover={x:event.pageX,y:event.pageY};a.moved(a.origin,b,c)}}.bind(this);this.element&&(this.element.addEventListener("mousedown",this._mouseDown,!1),document.addEventListener("mouseup",this._mouseUp,!1),document.addEventListener("mousemove",this._mouseMove,!1))},stop:function(){this.element&&
(this.element.removeEventListener("mousedown",this._mouseDown),document.removeEventListener("mouseup",this._mouseUp),document.removeEventListener("mousemove",this._mouseMove))},moved:function(a,b,c){this.phi+=c.x*this.speed/this.width;this.theta=Math.min(\u03c0/2,Math.max(-\u03c0/2,this.theta+c.y*this.speed/this.height));this.emit("change")},update:function(){this.camera.position.x=Math.cos(this.phi)*Math.cos(this.theta)*this.orbit;this.camera.position.y=Math.sin(this.theta)*this.orbit;this.camera.position.z=
Math.sin(this.phi)*Math.cos(this.theta)*this.orbit;this.camera.position.addSelf(this.lookAt);this.camera.lookAt(this.lookAt)}};ThreeBox.OrbitControls.bind=function(a,b,c){return new ThreeBox.OrbitControls(a,b,c)};MicroEvent.mixin(ThreeBox.OrbitControls);
ThreeBox.Cursor=function(a,b){function c(){e||(a.style.cursor=d);clearTimeout(f);e=!1;f=setTimeout(function(){e=!0;a.style.cursor="none"},h)}var d=b.cameraControls?"move":"default",f=null,e=!1,h=2E3;b.cursor?a.style.cursor=d:(a.addEventListener("mousemove",c),a.style.cursor="none");return{unbind:function(){a.removeEventListener("mousemove",c)}}};ThreeBox.Cursor.bind=function(a,b){return ThreeBox.Cursor(a,b)};
ThreeBox.preload=function(a,b){a instanceof Function&&(b=a,a=[]);var a="string"==typeof a?[a]:a,c=a.length;_.each(a,function(a){new microAjax(a,function(a){var d;(d=a.match(/^<script[^>]*type=['"]text\/javascript['"][^>]*>([\s\S]+?)<\/script>$/m))?(a=document.createElement("script"),a.type="text/javascript",a.innerHTML=d[1],document.body.appendChild(a)):(d=document.createElement("div"),d.innerHTML=a,document.body.appendChild(d));0==--c&&b()})})};
(function(a){for(var b in a)if(!window[b])throw"Error: ThreeRTT requires "+a[b];})({THREE:"Three.js"});window.ThreeRTT=window.ThreeRTT||{};ThreeRTT.getShader=function(a){var b=document.getElementById(a);return b&&b.innerText||a};_.loop=function(a,b){for(var c=0;c<a;++c)b(c)};ThreeRTT.getShader=function(a){var b=document.getElementById(a);return b&&(b.innerText||b.textContent)||a};ThreeRTT.isPowerOfTwo=function(a){return 0===(a&a-1)};
ThreeRTT.toTarget=function(a){return ThreeRTT.Stage&&a instanceof ThreeRTT.Stage?a.target:ThreeRTT.World&&a instanceof ThreeRTT.World?a.target():a};ThreeRTT.toTexture=function(a){a=ThreeRTT.toTarget(a);if(ThreeRTT.RenderTarget&&a instanceof ThreeRTT.RenderTarget)return a.read()};MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};
MicroEvent.mixin=function(a){for(var b=["bind","unbind","trigger","on","emit"],c=0;c<b.length;c++)a.prototype[b[c]]=MicroEvent.prototype[b[c]]};
ThreeRTT.Stage=function(a,b){b=_.extend({history:0,camera:{},material:!1,scene:null},b);b.camera.aspect=b.camera.aspect||b.width/b.height;this.scene=b.scene||new THREE.Scene;this.camera=ThreeRTT.Camera(b.camera);this.scene.add(this.camera);this.target=new ThreeRTT.RenderTarget(a,b);0<=b.history&&(b.material=b.material||new ThreeRTT.FragmentMaterial(this));b.material&&this.material(!0,b.material)};
ThreeRTT.Stage.prototype={material:function(a){a?(this._surface||(this._surface=new THREE.Mesh(new ThreeRTT.ScreenGeometry,{}),this._surface.frustumCulled=!1,this.scene.add(this._surface)),this._surface.material=a):(this.scene.remove(this._surface),this._surface=null);return this},size:function(a,b){this.camera.aspect=a/b;this.target.size(a,b);return this},read:function(a){return this.target.read(a)},uniform:function(){return this.target.uniform()},render:function(){this.target.clear();this.target.render(this.scene,
this.camera);return this},clear:function(){this.target.clear();return this},destroy:function(){this.target.deallocate();this.target=this.camera=this.scene=null}};ThreeRTT.Compose=function(a,b,c,d,f){b=new ThreeRTT.FragmentMaterial(b,c,d,f);c=new ThreeRTT.ScreenGeometry;b=new THREE.Mesh(c,b);b.frustumCulled=!1;a.add(b);this.scene=a;this.mesh=b};ThreeRTT.Compose.prototype.remove=function(){this.scene.remove(this.mesh)};
ThreeRTT.Camera=function(a){if(a.constructor instanceof THREE.Camera)return a;a=_.extend({aspect:1,far:1E4,fov:85,near:0.01,ortho:!1,scale:1},a);if(a.ortho){var b=a.scale,c=a.aspect;return new THREE.OrthographicCamera(-b*c,b*c,-b,b,a.near,a.far)}return new THREE.PerspectiveCamera(a.fov,a.aspect,a.near,a.far)};
ThreeRTT.RenderTarget=function(a,b){this.options=b=_.extend({width:256,height:256,texture:{},clear:{color:!1,depth:!0,stencil:!0},clearColor:16777215,clearAlpha:0,history:0,scene:null,camera:null,autoAdvance:!0},b);this.renderer=a;if((!ThreeRTT.isPowerOfTwo(b.width)||!ThreeRTT.isPowerOfTwo(b.height))&&!b.texture.minFilter)b.texture.minFilter=THREE.LinearFilter;this.history(this.options.history,!0);this.size(b.width,b.height)};
ThreeRTT.RenderTarget.prototype={read:function(a){a=Math.min(this.options.history,Math.abs(a||0));return this.virtuals[a]},write:function(){return this.targets[this.index]},history:function(a,b){void 0!==a&&(this._history=a,this.buffers=a+2,b||this.allocate());return this._history},size:function(a,b){a&&b&&(this.width=Math.floor(a),this.height=Math.floor(b),this.allocate());return{width:this.width,height:this.height}},deallocate:function(){this.deallocateTargets()},allocate:function(){this.deallocateTargets();
this.allocateTargets();this.allocateVirtuals()},deallocateTargets:function(){_.each(this.targets||[],function(a){this.renderer.deallocateRenderTarget(a)}.bind(this))},allocateTargets:function(){var a=this.options;n=this.buffers;var b=this.targets=[];_.loop(n,function(c){b.push(new THREE.WebGLRenderTarget(this.width,this.height,a.texture));b[c].__index=c}.bind(this))},allocateVirtuals:function(){var a=this.targets[0],b=this.virtuals||[];n=this.buffers-1;n>b.length?_.loop(n-b.length,function(){b.push(a.clone())}.bind(this)):
b=b.slice(0,n);_.each(b,function(a,b){a.width=this.width;a.height=this.height;a.__index=b}.bind(this));this.virtuals=b;this.index=-1;this.advance()},advance:function(){var a=this.targets,b=this.virtuals,c=this.index,d=this.buffers;this.index=c=(c+1)%d;_.loop(d-1,function(f){var e=b[f],f=a[(d-1-f+c)%d];e.__webglTexture=f.__webglTexture;e.__webglFramebuffer=f.__webglFramebuffer;e.__webglRenderbuffer=f.__webglRenderbuffer;e.__index=f.__index})},clear:function(){var a=this.options,b=a.clear,c=this.renderer;
c.setClearColorHex(a.clearColor,a.clearAlpha);c.clearTarget(this.write(),b.color,b.stencil,b.depth)},render:function(a,b){this.emit("render",a,b);var c=this.renderer.autoClear;this.renderer.autoClear=!1;this.clear();this.renderer.render(a,b,this.write());this.renderer.autoClear=c;this.options.autoAdvance&&this.advance()},uniform:function(a){var b=this.history();if(b){var c=[];_.loop(b+1,function(a){c.push(this.read(-a))}.bind(this));return{type:"tv",value:a,texture:c,count:b+1}}return{type:"t",value:a,
texture:this.read(),count:1}}};MicroEvent.mixin(ThreeRTT.RenderTarget);ThreeRTT.ScreenGeometry=function(){return new THREE.PlaneGeometry(2,2,1,1)};
ThreeRTT.FragmentMaterial=function(a,b,c,d){c=c||{};if(c instanceof Array){var f={};_.each(c,function(a){f["texture"+(e+1)]=a});c=f}else c.constructor!=Object&&(c={texture1:c});a instanceof Array||(a=[a]);a=_.map(a,function(a){return ThreeRTT.toTarget(a)});d=_.extend(d||{},{sampleStep:{type:"v2",value:new THREE.Vector2}});_.each(c,function(a,b){d[b]={type:"t",texture:ThreeRTT.toTexture(a)}});_.each(a,function(a,b){var c="texture"+(b+1);d[c]||(d[c]={type:"t",texture:a.read()})});var e=0;_.each(d,function(a){if("t"==
a.type)return a.value=e++;"tv"==a.type&&(a.value=e,e+=a.texture.length)});d.texture1&&!d.texture&&(d.texture=d.texture1);console.log(b,d);a[0].on("render",function(){var b=d.sampleStep.value;b.x=1/(a[0].width-1);b.y=1/(a[0].height-1)});return new THREE.ShaderMaterial({uniforms:d,vertexShader:ThreeRTT.getShader("generic-vertex-screen"),fragmentShader:ThreeRTT.getShader(b||"generic-fragment-texture")})};
ThreeRTT.DownsampleMaterial=function(a,b){var c={},a=ThreeRTT.toTarget(a),b=ThreeRTT.toTarget(b),c=_.extend(c,{sampleAlignment:{type:"v2",value:new THREE.Vector2},texture:{type:"t",value:0,texture:a.read()}});b.on("render",function(){var d=a,f=b,e=2*f.height/d.height,h=c.sampleAlignment.value;h.x=2*f.width/d.width;h.y=e});return new THREE.ShaderMaterial({uniforms:c,vertexShader:ThreeRTT.getShader("rtt-vertex-downsample"),fragmentShader:ThreeRTT.getShader("generic-fragment-texture")})};
ThreeRTT.RaytraceMaterial=function(a,b,c,d){c instanceof Array?_.each(c,function(){}):c.constructor!=Object&&(c={texture1:c});var a=ThreeRTT.toTarget(a),d=_.extend(d||{},{cameraViewport:{type:"v2",value:new THREE.Vector2},cameraWorld:{type:"m4",value:new THREE.Matrix4}}),f=0;_.each(c||[],function(a,b){d[b]={type:"t",value:f++,texture:ThreeRTT.toTexture(a)}});a.on("render",function(a,b){b.updateMatrixWorld();if(b.fov){var c=Math.tan(b.fov*\u03c0/360);d.cameraViewport.value.set(c*b.aspect,c)}b.matrixWorld&&
(d.cameraWorld.value=b.matrixWorld)});return new THREE.ShaderMaterial({uniforms:d,vertexShader:ThreeRTT.getShader("generic-vertex-screen"),fragmentShader:ThreeRTT.getShader(b)})};(function(a){for(var b in a)if(!window[b])throw"Error: ShaderGraph requires "+a[b];})({THREE:"Three.js"});window.ShaderGraph={};ShaderGraph.getShader=function(a){var b=document.getElementById(a);return b&&b.innerText||a};
(function(a){a.Block=function(b){b=b||new a.Node;this.node(b);this.children=[];this.parent=null;this.properties={};this.index=++a.Block.index;this.refresh()};a.Block.index=0;a.Block.prototype={node:function(a){return void 0!==a?(this._node=a,this):this._node},refresh:function(){this._node.owner(this);this._node.outlets(this.outlets())},fetch:function(){}};a.Block.Snippet=function(b){this.snippet=new a.Snippet(b);a.Block.call(this)};a.Block.Snippet.prototype=_.extend({},a.Block.prototype,{insert:function(b,
c,d){a.Block.Snippet.compileCall(b,c,this.node(),this.snippet,d)},fetch:function(a,c,d,f){a.include(this,c)||this.insert(a,c,f);return d.id()},outlets:function(){return a.Block.Snippet.makeOutlets(this.snippet)}});a.Block.Material=function(b,c){this.vertex=new a.Snippet(b);this.fragment=new a.Snippet(c);a.Block.call(this)};a.Block.Material.prototype=_.extend({},a.Block.prototype,{compile:function(){if(0<this.node().outputs.length)throw"Can't compile material with outputs";this.node();var b=new a.Program;
this.insert(b,"vertex",0);this.insert(b,"fragment",0);b.compile();return b},insert:function(b,c,d){a.Block.Snippet.compileCall(b,c,this.node(),this[c],d)},fetch:function(a,c,d,f){a.include(this,c)||this.insert(a,c,f);"fragment"==c&&(a.include(this,"vertex")||this.insert(a,"vertex",0));return d.id()},outlets:function(){var b=a.Block.Snippet.makeOutlets(this.vertex),c=a.Block.Snippet.makeOutlets(this.fragment);return _.union(b,c)}});a.Block.Snippet.makeOutlets=function(b){var c=[];if(b.outlets)return b.outlets;
var d=b.arguments();_.each(d.parameters,function(a){a.meta={required:!0};a.hint=a.name.replace(/(In|Out)$/,"");a.category="parameter";c.push(a)});_.each(d.uniforms,function(b){b.meta={};b.hint=b.name.replace(/(In|Out)$/,"");b.category="uniform";b.inout=a.IN;c.push(b)});return b.outlets=c};a.Block.Snippet.compileCall=function(b,c,d,f,e){var h=f.arguments(),g=[];_.each(h.parameters,function(f){var h=d.get(f.name);if(f.inout==a.IN)if(h.input)h=h.input.node.owner().fetch(b,c,h.input,e+1),b.variable(c,
h,f),g.push(h);else throw console.log("Outlet",f,h),["Missing connection on outlet for "+f.name];else f.inout==a.OUT&&(h=h.id(),b.variable(c,h,f),g.push(h))});var i=[];_.each(h.uniforms,function(a){var f=d.get(a.name);f.input?(f=f.input.node.owner().fetch(b,c,f.input,e+1),b.variable(c,f,a),g.push(f),i.push(a.name)):b.external("uniform",a)});_.each(h.attributes,function(a){b.external("attribute",a)});_.each(h.varyings,function(a){b.external("varying",a)});h=["_sg",c,f.name,d.owner().index].join("_");
f=f.compile(h,i,!0);b.add(c,h,g,f,e)}})(ShaderGraph);
(function(a){a.Factory=function(){this.end()};a.Factory.prototype={snippet:function(b,c){var c=c||"append",d=new a.Block.Snippet(ShaderGraph.getShader(b));this[c](d.node());return this},material:function(b,c,d){d=d||"append";b=new a.Block.Material(ShaderGraph.getShader(b),ShaderGraph.getShader(c));this[d](b.node());return this},snippetBefore:function(a){this.snippet(a,"prepend");return this},materialBefore:function(){this.material(code,"prepend");return this},append:function(a){a.graph||this.graph.add(a);
var c=this.stack[0];_.each(c.end,function(c){c.connect(a)});c.start.length||(c.start=[a]);c.end=[a];return this},prepend:function(a){a.graph||this.graph.add(a);var c=this.stack[0];_.each(c.start,function(c){a.connect(c)});c.end.length||(c.end=[a]);c.start=[a];return this},group:function(){this.stack.unshift({start:[],end:[]});this.stack.unshift({start:[],end:[]});return this},next:function(){var a=this.stack.shift(),c=this.stack[0];c.start=c.start.concat(a.start);c.end=c.end.concat(a.end);this.stack.unshift({start:[],
end:[]});return this},combine:function(){if(2>=this.stack.length)throw"Popping factory stack too far.";this.next();this.stack.shift();var a=this.stack.shift(),c=this.stack[0];_.each(a.start,function(a){_.each(c.end,function(b){b.connect(a,!0)})});c.end=a.end;return this},end:function(){var b=this.graph;this.graph=new a.Graph;this.stack=[];this.group();b&&(b.compile=function(){return b.tail().owner().compile()});return b}}})(ShaderGraph);
(function(a){a.Program=function(){this.calls={vertex:{},fragment:{}};this.variables={vertex:{},fragment:{}};this.externals={};this.compiled=!1;this.attributes={};this.uniforms={};this.fragmentShader=this.vertexShader="";this.includes={vertex:[],fragment:[]}};a.Program.types={f:"float",v2:"vec2",v3:"vec3",v4:"vec4",m3:"mat3",m4:"mat4",t:"sampler2D"};a.Program.prototype={include:function(a,c){if(0<=this.includes[c].indexOf(a))return!0;this.includes[c].push(a);return!1},external:function(a,c){c=_.extend({category:a},
c);this.externals[c.name]=c},variable:function(a,c,d){d=_.extend({},d,{name:c});this.variables[a][c]=d},add:function(a,c,d,f,e){var h=this.calls[a][c];h?h.priority=Math.min(h.priority,e):this.calls[a][c]={name:c,args:d,code:f,priority:e}},compile:function(){_.each(this.externals,function(a){"uniform"==a.category&&(this.uniforms[a.name]={type:a.type,value:a.value});"attribute"==a.category&&(this.attributes[a.name]={type:a.type,value:[]})}.bind(this));_.each(["vertex","fragment"],function(b){var c=
[];_.each(this.externals,function(a){"attribute"==a.category&&"fragment"==b||c.push([a.category,a.signature,";"].join(" "))}.bind(this));var c=c.join("\n"),d=_.toArray(this.calls[b]),f=[c],e=["void main() {"];_.each(this.variables[b],function(b){e.push([a.Program.types[b.type],b.name,";"].join(" "))});d.sort(function(a,b){return b.priority-a.priority});_.each(d,function(a){f.push(a.code);e.push([a.name,"(",a.args.join(","),");"].join(""))});e.push("}");this[b+"Shader"]=[f.join("\n"),e.join("\n")].join("\n")}.bind(this));
this.compiled=!0},material:function(){if(!this.compiled)throw"Fetching material from uncompiled program.";return new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:this.vertex,fragmentShader:this.fragment})}}})(ShaderGraph);
(function(a){a.Snippet=function(b){if(a.Snippet.cache[b])return a.Snippet.cache[b];a.Snippet.cache[b]=this;this.code=b;this.attributes=[];this.uniforms=[];this.varyings=[];this.parameters=[];this.body=this.signature="";this.parseCode(b)};a.Snippet.cache={};a.Snippet.types={"float":"f",vec2:"v2",vec3:"v3",vec4:"v4",mat3:"m3",mat4:"m4",sampler2D:"t",samplerCube:"t"};a.Snippet.defaults={"float":0,vec2:new THREE.Vector3,vec3:new THREE.Vector3,vec4:new THREE.Vector4,mat4:new THREE.Matrix4,sampler2D:0,
samplerCube:0};a.Snippet.prototype={compile:function(a,c,d){var f=this.signature.slice(),e=[],c=c||[];_.each(this.uniforms,function(a){0<=c.indexOf(a.name)?f.push(a.signature):d||e.push(["uniform",a.signature].join(" "))});!d&&_.each(this.attributes,function(a){e.push(["attribute",a.signature].join(" "))});!d&&_.each(this.varyings,function(a){e.push(["varying",a.signature].join(" "))});a=this.body.replace(/\s*void\s+([A-Za-z0-9]+)\s*\([^\)]*\)/g,["void",a+"(",f.join(", "),")"].join(" "));e.push(a);
return e.join(";\n")},arguments:function(){return{uniforms:this.uniforms,varyings:this.varyings,attributes:this.attributes,parameters:this.parameters}},type:function(b,c){b=(a.Snippet.types[b]||"f")+(c?"v":"");return"fv"==b?"fv1":b},parseAttribute:function(a){var c=a[1];this.attributes.push({name:a[3],type:this.type(a[2],a[4]),signature:c})},parseUniform:function(b){var c=b[1],d=b[2];this.uniforms.push({name:b[3],type:this.type(d,b[4]),value:a.Snippet.defaults[d]||0,signature:c})},parseVarying:function(a){var c=
a[1];this.varyings.push({name:a[3],type:this.type(a[2],a[4]),signature:c})},parseSignature:function(b){this.name=b[1];var c=b[2].replace(/^\s*$/g,"");0==c.length?this.signature=[]:(arguments=this.signature=c.split(","),_.each(arguments,function(b){var b=/((?:(in|out|inout)\s+)?([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/.exec(b),c=b[1];this.parameters.push({inout:{"in":a.IN,out:a.OUT,inout:a.INOUT}[b[2]||"in"],name:b[4],type:this.type(b[3],b[5]),signature:c})}.bind(this)))},parseCode:function(a){function c(a,
b){if(!a.global)throw"Can't findAll non-global regexp";for(var c,d=[];c=a.exec(b);)d.push(c);return d}var a=a.replace(/\r\n?/g,"\n").replace(/\/\/[^\n]*\n/g," ").replace(/\/\*(.|\n)*?\*\//g," "),d=c(/(?:^|;)\s*attribute\s+(([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),f=c(/(?:^|;)\s*uniform\s+(([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),e=c(/(?:^|;)\s*varying\s+(([A-Za-z0-9]+)\s+([[A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),h=c(/(?:^|;)\s*void\s+([A-Za-z0-9]+)\s*\(([^\)]*)\)\s*{/g,
a);if(!h[0])throw"Could not parse shader snippet. Must contain a void-returning function with in/outs: "+a;var g=a;_.each({parseAttribute:d,parseUniform:f,parseVarying:e},function(a,b){_.each(a,function(a){this[b](a);g=g.replace(a[0],"")}.bind(this))}.bind(this));g=g.replace(/^\s*;/,"");this.parseSignature(h[0]);this.body=g}}})(ShaderGraph);
(function(a){a.Graph=function(a,c){this.parent=c||null;this.nodes=[];a&&this.add(a)};a.Graph.prototype={iterate:function(a){_.each(this.nodes,function(c){a(c,c._owner)})},exposed:function(){var a=[];this.iterate(function(c){_.each(c.outlets(),function(c){c.exposed&&a.push(c)})});return a},inputs:function(){var a=[];this.iterate(function(c){_.each(c.inputs,function(c){null==c.input&&a.push(c)})});return a},outputs:function(){var a=[];this.iterate(function(c){_.each(c.outputs,function(c){0==c.output.length&&
a.push(c)})});return a},tail:function(){return this.nodes[this.nodes.length-1]},add:function(a){if(a.constructor==Array)return _.each(a,function(a){this.add(a)}.bind(this));if(a.graph)throw"Adding node to two graphs at once";a.link(this);this.nodes.push(a)},remove:function(a,c){var d=this;if(a.constructor==Array)return _.each(a,function(a){d.remove(a)});if(a.graph!=this)throw"Removing node from wrong graph.";c||a.disconnect();this.nodes.splice(this.nodes.indexOf(a),1)}};a.IN=0;a.OUT=1;a.INOUT=2})(ShaderGraph);
(function(a){a.Node=function(a,c){this.graph=null;this.inputs=[];this.outputs=[];this._outlets={};this.owner(a);this.outlets(c)};a.Node.prototype={owner:function(a){return void 0!==a?(this._owner=a,this):this._owner},link:function(a){this.graph=a},getIn:function(b){return this.get(b,a.IN)},getOut:function(b){return this.get(b,a.OUT)},get:function(b,c){return void 0===c?this.get(b,a.IN)||this.get(b,a.OUT):this._outlets[[b,c].join("-")]},key:function(a){return[a.name,a.inout].join("-")},outlets:function(b){if(void 0!==
b){var c={};_.each(b,function(a){c[[a.name,a.inout,a.type].join("-")]=!0}.bind(this));_.each(this._outlets,function(a){c[[a.name,a.inout,a.type].join("-")]||this.remove(a)}.bind(this));_.each(b,function(b){var c=this.get(b.name,b.inout);c?c.morph(b):(b=new a.Outlet(b),this.add(b))}.bind(this));return this}return this._outlets},add:function(b){var c=this.key(b);outlets=this._outlets;_in=this.inputs;_out=this.outputs;if(b.node)throw"Adding outlet to two nodes at once.";if(outlets[c])throw"Adding two identical outlets to same node.";
b.link(this);outlets[c]=b;(b.inout==a.IN?_in:_out).push(b);return this},remove:function(b){var c=this._outlets,d=this.key(b),f=b.inout==a.IN?this.inputs:this.outputs;if(b.node!=this)throw"Removing outlet from wrong node.";b.disconnect();b.link(null);delete c[d];f.splice(f.indexOf(b),1);return this},connect:function(a,c,d){var f={},e={},h;h={};_.each(a.inputs,function(a){if(d||!a.input){var b=a.type,c=[b,a.hint].join("-"),j=h[b]=(h[b]||0)+1,b=[b,j].join("-");e[c]=a;f[b]=a}});h={};_.each(this.outputs,
function(a){if(!c||!a.output.length){var b=a.type,d=[b,a.hint].join("-");e[d]?e[d].connect(a):(d=h[b]=(h[b]||0)+1,b=[b,d].join("-"),f[b]&&f[b].connect(a))}});return this},disconnect:function(){_.each(this.inputs,function(a){a.disconnect()});_.each(this.outputs,function(a){a.disconnect()});return this}}})(ShaderGraph);
(function(a){a.Outlets=0;a.Outlet=function(b,c,d,f,e,h,g){if("object"==typeof b)return new a.Outlet(b.inout,b.name,b.hint,b.type,b.category,b.exposed);this.node=null;this.inout=b;this.name=c;this.hint=d||c;this.type=f;this.category=e;this.exposed=!!h;this.meta=g||{};this.index=++a.Outlets;this.input=null;this.output=[]};a.Outlet.prototype={id:function(){return["_sg",this.name,this.index].join("_")},expose:function(a){this.exposed=a},morph:function(a){this.inout=a.inout;this.name=a.name;this.type=
a.type;this.category=a.category;this.exposed=a.exposed;this.meta=a.meta||{}},connect:function(b){if(this.inout==a.IN&&b.inout==a.OUT)return b.connect(this);if(this.inout!=a.OUT||b.inout!=a.IN)throw console.log(this,b),"Can't connect out/out or in/in outlets.";b.input!=this&&(b.disconnect(),b.input=this,this.output.push(b))},disconnect:function(b){if(this.inout==a.IN)this.input&&this.input.disconnect(this);else if(b){var c=this.output.indexOf(b);0<=c&&(this.output.splice(c,1),b.input=null)}else _.each(this.output,
function(a){a.input=null}),this.output=[]},link:function(a){this.node=a}}})(ShaderGraph);\u03c0=Math.PI;\u03c4=2*\u03c0;(function(a){for(var b in a)if(!window[b])throw"Error: MathBox requires "+a[b];})({THREE:"Three.js",tQuery:"tQuery.js (bundle)",ThreeBox:"ThreeBox.js",ThreeRTT:"ThreeRTT.js"});window.MathBox={};window.mathBox=function(a,b){a&&!(a instanceof Node)&&(b=a,a=null);return tQuery.createWorld(b).mathBox(a,b)};
MathBox.getShader=function(a){var b=document.getElementById(a);return b&&b.innerText||a};Math.sign=function(a){return 0<a?1:0>a?-1:0};MathBox.Attributes=function(){};
MathBox.Attributes.prototype={get:function(a){return void 0===a?this.__attributes||{}:!this.__attributes?void 0:this.__attributes[a]},set:function(a,b){function c(a,b){try{var c=b;if(void 0===f[a]){var j="validate"+a.charAt(0).toUpperCase()+a.slice(1);f[a]=h[j]||!1}b=f[a]?f[a](c):c;d[a]=b;e[a]=b}catch(l){throw"Exception setting '"+a+"' to '"+b+"': "+l;}}this.__attributes||(this.__attributes={});this.__validators||(this.__validators={});var d={},f=this.__validators,e=this.__attributes,h=this;void 0===
a||null===a||(a.constructor==String?c(a,b):_.each(a,function(a,b){c(b,a)}),this.emit("change",d))}};MicroEvent.mixin(MathBox.Attributes);MathBox.Attributes.mixin=function(a){_.each(["get","set","on","emit"],function(b){a.prototype[b]=MathBox.Attributes.prototype[b]})};MathBox.Animator=function(){this.active=[]};
MathBox.Animator.prototype={finalState:function(a){var b=_.extend({},a.get());a.__queue&&_.each(a.__queue,function(a,d){_.each(a,function(a){a.to&&(b[d]=a.to)})});return b},attach:function(a){if(!a.__queue){if(!a.__attributes)throw"Cannot attach to object without attributes";var b=this,c=a.set;a.set=function(a,f,e){if(!e){e=a;if(void 0===a||null===a)return;a.constructor==String&&(e={},e[a]=f);b.stop(this,e)}c.call(this,a,f)};a.__queue={};a.__animations=0}},hurry:function(a,b,c){c=c||300;_.each(b||
a.__queue,function(b,f){_.each(a.__queue[f],function(a){a instanceof MathBox.Animator.Delay&&(a.duration=0);a instanceof MathBox.Animator.Animation&&(a.duration=Math.min(a.duration,c))})}.bind(this))},stop:function(a,b){_.each(b||a.__queue,function(b,d){for(;a.__queue[d];)this.dequeue(a,d,!0)}.bind(this))},animate:function(a,b,c){c=_.extend({duration:300},c||{});this.attach(a);_.each(b,function(b,f){var e=a.__queue[f]=a.__queue[f]||[];if(c.delay){var h=new MathBox.Animator.Delay(a,f,c.delay);e.push(h);
0==a.__animations++&&this.active.push(a)}a.__validators[f]&&(b=a.__validators[f](b));h=new MathBox.Animator.Animation(a,f,b,c.duration,c.callback,c.ease);e.push(h);0==a.__animations++&&this.active.push(a)}.bind(this))},dequeue:function(a,b,c){var d=a.__queue[b];if(d){var f=d.shift();0==d.length&&delete a.__queue[b];c&&f.skip();0==--a.__animations&&this.active.splice(this.active.indexOf(a),1)}},update:function(){_.each(this.active,function(a){_.each(a.__queue,function c(d,f){var e=d[0];value=e.apply();
e.done()&&(this.dequeue(a,f),d[0]&&c.call(this,d,f))}.bind(this))}.bind(this))}};MathBox.Animator.Delay=function(a,b,c){this.object=a;this.key=b;this.duration=c;this.fraction=this.start=0};MathBox.Animator.Delay.prototype={init:function(){this.start=+new Date},apply:function(){this.start||this.init();this.fraction=0<this.duration?Math.min(1,(+new Date-this.start)/this.duration):1},skip:function(){this.duration=0},done:function(){return 1==this.fraction}};
MathBox.Animator.Animation=function(a,b,c,d,f,e){this.object=a;this.key=b;this.from=null;this.to=c;this.duration=d;this.fraction=this.start=0;this.callback=f;this.ease=e};
MathBox.Animator.Animation.prototype={init:function(){this.start=+new Date;null===this.from&&(this.from=this.object.get(this.key));void 0===this.from&&(this.from=0)},apply:function(){function a(c,d){void 0===d&&(d=c);if(d===c)return c;if(typeof c!=typeof d)throw console.log(b,f),"Data type mismatch between from/to values in animator. "+f+": "+c+" ("+c.constructor+"), "+d+"("+d.constructor+")";var e;switch(typeof d){default:case "string":throw"Unimplemented value type in animator. ("+typeof d+")";
case "function":return function(){return a(c.apply(this,arguments),d.apply(this,arguments))};case "boolean":return 0.5<h?d:c;case "number":return c+(d-c)*g;case "object":if(d.constructor==Array)return e=[],_.loop(c.length,function(b){e[b]=a(c[b],d[b])}),e;if(d.constructor==THREE.Matrix4){e=new THREE.Matrix4;for(var l=0;16>l;++l)e.elements[l]=c.elements[l]+(d.elements[l]-c.elements[l])*g;return e}if(d.constructor==THREE.Vector3)return e=new THREE.Vector3,e.x=c.x+(d.x-c.x)*g,e.y=c.y+(d.y-c.y)*g,e.z=
c.z+(d.z-c.z)*g,e;if(d.constructor==THREE.Color)return e=new THREE.Color,e.r=c.r+(d.r-c.r)*g,e.g=c.g+(d.g-c.g)*g,e.b=c.b+(d.b-c.b)*g,e;throw"Unimplemented value type in animator. "+typeof d+" ("+d.constructor+")";}}this.start||this.init();var b=this.object,c=this.from,d=this.to,f=this.key,e=this.ease,h;this.fraction=h=0<this.duration?Math.min(1,(+new Date-this.start)/(this.duration||1)):1;var g;switch(e){case "in":g=1-(1-h)*(1-h);break;case "out":g=h*h;break;default:g=0.5-0.5*Math.cos(h*\u03c0)}this.object.set(this.key,
a(c,d),!0)},skip:function(){this.duration=0;this.fraction=1;this.done()},done:function(){return 1==this.fraction?(this.object.set(this.key,this.to,!0),this.callback&&this.callback(),this.callback=null,!0):!1}};MathBox.Stage=function(a,b,c){this.options=a||{};this._world=b;this.cssOverlay=c;this.primitives=[];this.materials=new MathBox.Materials(this);this.animator=new MathBox.Animator;this.duration=0;b&&(this.cameraProxy=new MathBox.CameraProxy(b,this.options));this.viewport({});this.loadPrimitives()};
MathBox.Stage.prototype=new THREE.Object3D;MathBox.Attributes.mixin(MathBox.Stage);MicroEvent.mixin(MathBox.Stage);
MathBox.Stage.prototype=_.extend(MathBox.Stage.prototype,{update:function(){var a=this._viewport;this.animator.update();a.update(this);_.each(this.primitives,function(b){b.adjust(a);b=b.renderables();_.each(b,function(b){b.object&&b.adjust(a)})})},add:function(a,b){if(a instanceof THREE.Object3D)return THREE.Object3D.prototype.add.call(this,a);this._add(a);var b=this.animateOptions(b),c=a.style.get("opacity");b&&0<c&&(a.style.set("opacity",0),this.animator.animate(a.style,{opacity:c},b));return this},
remove:function(a,b){if(a instanceof THREE.Object3D)return THREE.Object3D.prototype.remove.call(this,a);"string"==typeof a&&_.each(this.select(a),function(a){this.remove(a,b)}.bind(this));var c=function(){this._remove(a)}.bind(this),b=this.animateOptions(b),d=a.style.get("opacity");b&&0<d?(b.callback=c,this.animator.animate(a.style,{opacity:0},b),a.removed=!0):c();return this},_add:function(a){var b=this.materials;-1==this.primitives.indexOf(a)&&(this.primitives.push(a),a.make(),a=a.renderables(),
_.each(a,function(a){a.make(b);a.object&&this.add(a.object)}.bind(this)))},_remove:function(a){if(-1!=this.primitives.indexOf(a)){this.primitives.splice(this.primitives.indexOf(a),1);var b=a.renderables();_.each(b,function(a){a.object&&this.remove(a.object);a.destroy()}.bind(this));a.destroy()}},select:function(a,b){var c=[];if("object"==typeof a)return a.constructor==Array?a:[a];var d=function(a){var c=[];if("*"==a)return c=this.primitives.slice(),c.push(this.viewport()),c.push(this.cameraProxy),
c;if(a==+a)return _.each(this.primitives,function(d){(b||!d.removed)&&d.get("sequence")==a&&c.push(d)}),c;var d=a.match(/^\s*#([a-zA-Z0-9_-]+)|([a-zA-Z0-9_-]+)?\s*$/);if(!d)return[];var g=d[2],i=d[1];if(i)_.each(this.primitives,function(a){(b||!a.removed)&&a.get("id")==i&&c.push(a)});else{if("camera"==g)return this.cameraProxy&&[this.cameraProxy]||[];if("viewport"==g)return[this.viewport()];g&&_.each(this.primitives,function(a){(b||!a.removed)&&a.type()==g&&c.push(a)})}return c}.bind(this),c=[],a=
(""+a).split(",");_.each(a,function(a){c=c.concat(d(a))});return c},set:function(a,b){b=this.extractStyle(b);_.each(this.select(a),function(a){a.set(b)})},get:function(a){var b=this.animator,a=this.select(a);if(1>a.length)return{};var c=a[0],a=b.finalState(c);c.style&&(b=b.finalState(c.style),a.style=b);return a},transition:function(a){return void 0!==a?(this.duration=a,this):this.duration},animateOptions:function(a,b){var c=this.duration;!0===a&&(a={});if(c||b||a&&(a.delay||a.duration))a=_.extend({duration:c||
300},a||{});if(a.delay||a.duration)return a},animate:function(a,b,c){var d=this.animator,b=this.extractStyle(b),c=this.animateOptions(c,!0);b.style&&(_.each(this.select(a),function(a){d.animate(a.style,b.style,c)}),b=_.extend({},b),delete b.style);_.each(this.select(a),function(a){d.animate(a,b,c)})},hurry:function(a,b,c){var d=this.animator;_.each(this.select(a,!0),function(a){d.hurry(a,b,c);a.style&&d.hurry(a.style,b,c)})},halt:function(a,b){var c=this.animator;_.each(this.select(a,!0),function(a){c.stop(a,
b);a.style&&c.stop(a.style,b)})},viewport:function(a){if(void 0!==a){if(!this._viewport||a.type&&a.type!=this.options.viewport.type){this._viewport=MathBox.Viewport.make(a);var a=this.primitives.slice(),b=this;_.each(a,function(){b._remove(this);b._add(this)})}else this._viewport.set(a);this.options.viewport=this._viewport.get();return this}return this._viewport},camera:function(a){_.each(this.select("camera"),function(b){b.set(a)});return this},start:function(){this._world&&this._world.start();return this},
stop:function(){this._world&&this._world.stop();return this},world:function(){return this._world},extractStyle:function(a){var b=MathBox.Style.prototype.defaults(),c=null;_.each(a,function(d,f){void 0!==b[f]&&(delete a[f],c=c||{},c[f]=d)});c&&(a.style=_.extend(a.style||{},c));return a},spawn:function(a,b,c){if(MathBox.Primitive.types[a])return this[a](b,c),this.primitives[this.primitives.length-1]},loadPrimitives:function(){_.each(MathBox.Primitive.types,function(a,b){this[b]=function(b,d){a.validateArgs&&
(b=a.validateArgs(b));var f=new a(this.extractStyle(b));this.add(f,d);return this}}.bind(this))}});MathBox.Materials=function(a){this.stage=a;this.list=[]};
MathBox.Materials.prototype={generic:function(a){var b=this.factory(),a=a||{},c=a.shaders||{};c.position?c.position(b,this):(this.position(b,a),a.absolute||this.viewport(b));return this.finalize(b,a)},position:function(a,b){b=b||{};a.snippet({mesh:"getPositionNormal"}[b.type]||"getPosition").snippet("mathTransform");return a},factory:function(){return new ShaderGraph.Factory},finalize:function(a,b){var b=b||{},c=b.shaders||{};a.snippet("projectToView");c.material?c.material(a,this):a.material("vertexOutput",
{points:"fragmentSolidPoint",mesh:b.shaded?"fragmentShaded":"fragmentSolid"}[b.type]||"fragmentSolid");c=a.end().compile();c=new THREE.ShaderMaterial({uniforms:c.uniforms,attributes:c.attributes,vertexShader:c.vertexShader,fragmentShader:c.fragmentShader});b.wireframe&&(c.wireframe=!0);var d=this.apply.bind(this);c.applyUniforms=function(a){d(this,a,"uniforms")};c.applyAttributes=function(a){d(this,a,"attributes")};return c},apply:function(a,b,c){var d=a[c];_.each(b,function(a,b){var c=d[b];c&&(a instanceof
THREE.Color&&(a.x=a.r,a.y=a.g,a.z=a.b),c.value=a,c.needsUpdate=!0)});"uniforms"==c&&(void 0!==b.lineWidth&&(a.wireframeLinewidth=a.linewidth=b.lineWidth),void 0!==b.opacity&&(a.transparent=1>b.opacity))},viewport:function(a,b){this.stage.viewport().shader(a,b)}};
MathBox.Ticks=function(a,b,c,d,f){var e=(b-a)/(c||10),d=d||1,c=d==\u03c0?2:10,h=d*Math.pow(c,Math.floor(Math.log(e/d)/Math.log(c))),d=_.map(c==\u03c0?[1]:[5,1,0.5],function(a){return h*a}),g=_.reduce(d,function(a,b){return Math.abs(b-e)<Math.abs(a-e)?b:a},h),f=+!f,a=(Math.ceil(a/g)+f)*g,b=(Math.floor(b/g)-f)*g,c=Math.ceil((b-a)/g)+1,i=[];_.loop(c,function(b){i.push(a+b*g)});return i};MathBox.TicksLog=function(){};
tQuery.World.register("mathBox",function(a,b){a=a||document.body;this.threeBox(a,b);var c=new Acko.CSS3DRenderer;a.appendChild(c.domElement);c.domElement.style.position="absolute";c.domElement.style.left=0;c.domElement.style.top=0;c.domElement.style.right=0;c.domElement.style.bottom=0;this.on("resize",function(a,b){c.setSize(a,b)});var d=new MathBox.Stage(b,this,c),f=function(){d.update()};this.tScene().add(d);this._renderer.setClearColorHex(16777215,1);d.unhook=function(){this.loop().unhookPreRender(f)};
this.loop().hookPreRender(f);if(!b.cameraControls){var e=this.tCamera();e.position.x=0;e.position.y=0;e.position.z=b.orbit;e.lookAt(new THREE.Vector3(0,0,0))}return d});MathBox.Director=function(a,b){this._stage=a;this.script=b;this.rollback={};this.lastCommand=this.step=0};
MathBox.Director.prototype={invert:function(a){var b=this._stage,c=[],d=a[0],f=a[1],e=a[2],h=a[3];switch(d){case "add":c.push(["remove",e.sequence||MathBox.Primitive.sequence+1]);break;case "remove":targets=b.select(f);_.each(targets,function(a){c.push(["add",a.type(),b.get(a)])});break;case "animate":case "set":targets=b.select(f),_.each(targets,function(a){var f=h&&Math.min(300,h.duration)||300;c.push([d,a.singleton||a.get("sequence"),b.get(a),{duration:f}])})}return c},apply:function(a,b,c){var d=
this._stage;_.each(a,function(a){var e=a[0]||"",h=a[1]||"",g=a[2]||{},i=a[3]||{};b&&(a=this.invert(a),a=[0,0].concat(a),Array.prototype.splice.apply(b,a));c&&(i&&(i=_.extend({},i),i.delay=0,i.duration=Math.min(300,i.duration)),g&&(g=_.extend({},g),g.delay=0,g.duration=Math.min(300,g.duration)));switch(e){case "add":d.spawn(h,g,i);break;case "remove":_.each(d.select(h),function(a){d.remove(a,g)});break;case "set":var e=d.select(h),k=g.constructor==Array;_.each(e,function(a,b){a.set(k?g[b]:g)});break;
case "animate":e=d.select(h),k=g.constructor==Array,_.each(e,function(a,b){d.animate(a,k?g[b]:g,i)})}}.bind(this));return this},insert:function(a){a[0].constructor!=Array&&(a=[a]);this.script.splice(this.step,0,a);this.forward();return this},go:function(a,b){if(this.script.length){for(;0>a;)a+=this.script.length+1;for(;a>=this.script.length+1;)a-=this.script.length+1;for(;a>this.step;)this.forward(b);for(;a<this.step;)this.back(b)}},skipping:function(){var a=+new Date,b=!1;500>a-this.lastCommand&&
(b=!0);this.stage().hurry("*");this.lastCommand=a;return b},forward:function(a){if(!(this.step>=this.script.length)){var b=this.script[this.step],c=this.rollback[this.step]=[];this.apply(b,c,a||this.skipping());this.step++;this.emit("go",this.step,1);return this}},back:function(a){if(!(0>=this.step))return this.step--,this.apply(this.rollback[this.step],null,a||this.skipping()),delete this.rollback[this.step],this.emit("go",this.step,-1),this},stage:function(){return this._stage}};
_.each(MathBox.Stage.prototype,function(a,b){MathBox.Director.prototype[b]||(MathBox.Director.prototype[b]=function(){var b=this.stage[a].apply(this.stage,arguments);return b===this.stage?this:b})});MicroEvent.mixin(MathBox.Director);MathBox.Style=function(a){var b=this.defaults(),a=_.extend(b,a||{});this.set(a)};
MathBox.Style.prototype={defaults:function(){return{color:new THREE.Color(3174640),opacity:1,lineWidth:2,pointSize:5,mathScale:new THREE.Vector3(1,1,1),mathRotation:new THREE.Vector3,mathPosition:new THREE.Vector3,worldScale:new THREE.Vector3(1,1,1),worldRotation:new THREE.Vector3,worldPosition:new THREE.Vector3,zIndex:0}},validateColor:function(a){if(a.constructor==Array){var b=new THREE.Color;return b.setRGB.apply(b,a)}return a.constructor==Number?new THREE.Color(a):a.constructor!=THREE.Color?this.get("color"):
a},validateMathScale:function(a){if(a.constructor==Array){var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("mathScale"):a},validateMathRotation:function(a){if(a.constructor==Array){var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("mathRotation"):a},validateMathPosition:function(a){if(a.constructor==Array){var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("mathPosition"):
a},validateWorldScale:function(a){if(a.constructor==Array){var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("worldScale"):a},validateWorldRotation:function(a){if(a.constructor==Array){var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("worldRotation"):a},validateWorldPosition:function(a){if(a.constructor==Array){var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("worldPosition"):
a}};MathBox.Attributes.mixin(MathBox.Style);MathBox.CameraProxy=function(a,b){this.set({orbit:b.orbit||3.5,phi:b.phi||\u03c4/4,theta:b.theta||0,lookAt:[0,0,0]});this.singleton="camera";var c=this.controls=a.getCameraControls()||ThreeBox.OrbitControls.bind(a.tCamera(),null,this.get());this.on("change",function(a){_.each(a,function(a,b){"lookAt"!=b&&(c[b]=a)});a.lookAt&&c.lookAt.set.apply(c.lookAt,a.lookAt);c.update()});c.update()};MathBox.Attributes.mixin(MathBox.CameraProxy);
MathBox.Primitive=function(a){if(null!==a){var b=this.defaults();a&&(a.style=_.extend(b.style,a.style||{}),a=_.extend(b,a||{}));a=a||b;this.set(a);this.renders=[];this.style=new MathBox.Style;this.style.set(this.get().style||{});this.on("change",function(a){void 0!==a.style&&this.style.set(a.style)}.bind(this));this.set("sequence",a.sequence||++MathBox.Primitive.sequence);this.set("id",a.id||this.sequence);this.init()}};MathBox.Primitive.sequence=0;MathBox.Primitive.types={};
MathBox.Primitive.prototype={defaults:function(){return{}},type:function(){return"primitive"},init:function(){},make:function(){},destroy:function(){},renderables:function(){return[]},adjust:function(){}};MathBox.Attributes.mixin(MathBox.Primitive);MicroEvent.mixin(MathBox.Primitive);MathBox.Curve=function(a){null!==a&&MathBox.Primitive.call(this,a)};
MathBox.Curve.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{n:64,domain:[0,1],data:null,expression:function(){return 0},live:!1,points:!1,line:!0,style:{}}},type:function(){return"curve"},renderables:function(){return[this.line,this.points]},adjust:function(){var a=this.get();this.line.show(a.line);this.points.show(a.points);a.live&&this.calculate()},make:function(){var a=this.get(),b=this.style,c=a.n,d=this.vertices=[];_.loop(c,function(){d.push(new THREE.Vector3)});
c=function(c){return new MathBox.Renderable.Mesh(d,{type:c,dynamic:a.live},b)};this.line=c("line");this.points=c("points");this.calculate()},calculate:function(){var a=this.vertices,b=this.get(),c=b.data,d=b.domain,f=b.n,e=d[0],h=(d[1]-e)/(f-1),g;_.loop(f,function(d){g=c&&void 0!==c[d]?c[d]:b.expression.call(this,e,d);g instanceof Array||(g=[e,g,0]);g=g.concat([0,0,0]);a[d].set.apply(a[d],g);e+=h}.bind(this))}});MathBox.Primitive.types.curve=MathBox.Curve;
MathBox.Bezier=function(a){MathBox.Curve.call(this,a)};
MathBox.Bezier.prototype=_.extend(new MathBox.Curve(null),{defaults:function(){return{n:64,domain:[0,1],data:null,order:3,expression:function(){return 0},live:!1,points:!1,line:!0,style:{}}},type:function(){return"bezier"},calculate:function(){var a=this.vertices,b=this.get(),c=b.domain,d=b.data,f=b.order,e=b.n;if(1>f||3<f)throw"Bezier curve order must be 1, 2 or 3.";var h=[],g;_.loop(f+1,function(a){g=d&&void 0!==d[a]?d[a]:b.expression.call(this,a,a);g instanceof Array||(g=[k,g,0]);g=g.concat([0,
0,0]);h.push(new THREE.Vector3(g[0],g[1],g[2]))}.bind(this));var i={bezierPoints:h},k=c[0],j=(c[1]-k)/(e-1);_.loop(e,function(b){a[b].set(k,0,0);k+=j});c={uniforms:i,shaders:{position:function(a,b){a.snippet("bezier"+f).snippet("mathTransform");b.viewport(a)}}};this.line.set(c);this.points.set(c)}});MathBox.Primitive.types.bezier=MathBox.Bezier;MathBox.Axis=function(a){null!==a&&MathBox.Primitive.call(this,a)};
MathBox.Axis.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{axis:0,offset:[0,0,0],n:2,ticks:10,tickBase:1,arrow:!0,size:0.07,style:{lineWidth:4,color:new THREE.Color(7368816)}}},renderables:function(){return[this.line,this.ticks,this.arrow]},type:function(){return"axis"},adjust:function(a){var b=this.get(),c=b.axis,d=b.offset,f=b.arrow,e=b.ticks,h=b.tickBase,b=b.n,g=this.points,i=this.tickPoints,k=this.tickSigns,j=[0,0,0],l=new THREE.Vector3,a=a.axis(c),m=a[0],a=a[1],q=
(a-m)/(b-1);l.set.apply(l,d);_.loop(b,function(a){j[c]=m+a*q;g[a].set.apply(g[a],j);g[a].addSelf(l)});this.arrow.show(f);this.ticks.show(!!e);if(e){d=MathBox.Ticks(m,a,e,h,!0);f=Math.floor(i.length/2);d.length>f&&(d=d.slice(0,f));var f=[0,0,0],r;f[2==c?0:1-c]=0.01*(a-m);this.epsilon.set.apply(this.epsilon,f);j=[0,0,0];_.each(d,function(a,b){b*=2;j[c]=a;i[b].set.apply(i[b],j);i[b].addSelf(l);k[b]=1;i[b+1].copy(i[b]);k[b+1]=-1;r=b+1});d=r+1;for(b=i.length;d<b;)i[d].copy(i[r]),k[d]=k[r],d++}window.ij=
!0},make:function(){var a=this.get(),b=a.n,c=a.ticks,d=this.style,f=this.points=[],e=this.tickPoints=[],h=this.tickSigns=[],g=this.epsilon=new THREE.Vector3;_.loop(b,function(){f.push(new THREE.Vector3)});_.loop(8*c,function(){e.push(new THREE.Vector3);h.push(1)});c={dynamic:!0,size:a.size,offset:0.5};a={dynamic:!0,size:0.2*a.size};this.line=new MathBox.Renderable.Mesh(f,{dynamic:!0,type:"line"},d);this.arrow=new MathBox.Renderable.ArrowHead(f[b-2],f[b-1],c,d);this.ticks=new MathBox.Renderable.Ticks(e,
h,g,a,d)}});MathBox.Axis.validateArgs=function(a){"number"==typeof a&&(a={axis:a});return a};MathBox.Primitive.types.axis=MathBox.Axis;MathBox.Grid=function(a){null!==a&&MathBox.Primitive.call(this,a)};
MathBox.Grid.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{axis:[0,1],offset:[0,0,0],show:[!0,!0],n:2,ticks:[10,10],tickBase:[1,1],style:{lineWidth:1,color:new THREE.Color(10526880)}}},type:function(){return"grid"},renderables:function(){return this.lines||[]},adjust:function(a){function b(a,b,c,d,f){var e=i.slice(),g=0,h=MathBox.Ticks(b.min,b.max,b.ticks,b.tickBase,!0);h.length>d&&(h=h.slice(0,d));_.each(h,function(d){e[b.axis]=d+i[b.axis];e[c.axis]=c.min+i[c.axis];_.loop(f-
1,function(){a[g].set.apply(a[g],e);g++;e[c.axis]+=c.inv;a[g].set.apply(a[g],e);g++})});d=Math.max(0,g-1);for(h=a.length;g<h;)a[g++].copy(a[d])}var c=this.get(),d=c.axis,f=c.ticks,e=c.tickBase,h=c.n,g=c.show,i=c.offset,c=this.points,k=this.limit,j=[];"number"==typeof h&&(h=[h,h]);_.each(d,function(b,c){var d=a.axis(b);j.push({axis:b,min:d[0],max:d[1],inv:(d[1]-d[0])/(h[c]-1),ticks:f[c],tickBase:e[c]})});this.lines[0].show(g[0]);this.lines[1].show(g[1]);g[0]&&b(c[0],j[1],j[0],k[0],h[0]);g[1]&&b(c[1],
j[0],j[1],k[1],h[1])},make:function(){var a=this.get(),b=a.ticks,c=a.n,d=this.points=[[],[]],a=this.style;"number"==typeof c&&(c=[c,c]);var f=this.limit=[0,0];_.each(b,function(a,b){b=1-b;f[b]=4*a;_.loop(2*f[b]*(c[b]-1),function(){d[b].push(new THREE.Vector3)})});this.lines=[];this.lines.push(new MathBox.Renderable.Mesh(d[0],{type:"line",strip:!1,dynamic:!0},a));this.lines.push(new MathBox.Renderable.Mesh(d[1],{type:"line",strip:!1,dynamic:!0},a))}});MathBox.Primitive.types.grid=MathBox.Grid;
MathBox.Vector=function(a){null!==a&&(MathBox.Primitive.call(this,a),this.render=[],this.line=this.points=this.vertices=null)};
MathBox.Vector.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{n:1,data:null,expression:function(){return 0},live:!1,style:{},size:0.07}},type:function(){return"vector"},renderables:function(){return this.render},adjust:function(a){this.get();this.calculate(a)},make:function(){var a=this.get(),b=this.style,c=a.n,d=this.vertices=[],f=this.points=[],e=this.render=[],h={dynamic:a.live,type:"line",strip:!1},g={size:a.size},i=0;_.loop(c,function(){d.push(new THREE.Vector3);d.push(new THREE.Vector3);
f.push(new THREE.Vector3);f.push(new THREE.Vector3);var a=new MathBox.Renderable.ArrowHead(f[i++],f[i++],g,b);e.push(a)});this.line=new MathBox.Renderable.Mesh(d,h,b);e.push(this.line);this.calculate()},calculate:function(a){var b=this.vertices,c=this.points,d=this.get(),f=d.data,e=d.n,h=d.size,g=new THREE.Vector3(1,1,1),i=new THREE.Vector3;if(a){var k=a.transform.elements,a=h/2/Math.abs(k[0]),j=h/2/Math.abs(k[5]),h=h/2/Math.abs(k[10]);g.set(a,j,h)}var l=0,m=0;_.loop(2*e,function(a){p=f&&void 0!==
f[a]?f[a]:d.expression.call(this,m,l);p instanceof Array||(p=[a,p,0]);p=p.concat([0,0,0]);c[a].set.apply(c[a],p);b[a].set.apply(b[a],p);if(1==a%2){i.sub(b[a],b[a-1]);i.x=Math.abs(i.x);i.y=Math.abs(i.y);i.z=Math.abs(i.z);var e=i.lengthManhattan(),e=1-i.dot(g)/e/i.length();i.sub(b[a],b[a-1]);i.multiplyScalar(e);b[a].add(b[a-1],i)}m=l?m+1:m;l=(l+1)%2}.bind(this))}});MathBox.Primitive.types.vector=MathBox.Vector;MathBox.Surface=function(a){null!==a&&MathBox.Primitive.call(this,a)};
MathBox.Surface.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{n:[64,64],domain:[[0,1],[0,1]],data:null,expression:function(){return 0},live:!1,points:!1,line:!1,mesh:!0,doubleSided:!0,flipSided:!1,shaded:!0,style:{}}},type:function(){return"surface"},renderables:function(){return[this.mesh,this.line,this.points]},adjust:function(){var a=this.get();this.mesh.show(a.mesh);this.line.show(a.line);this.points.show(a.points);a.live&&this.calculate()},make:function(){var a=this.get(),
b=this.style,c=a.n;"number"==typeof c&&(c=[c,c]);c=this.geometry=new THREE.PlaneGeometry(2,2,c[0]-1,c[1]-1);this.vertices=c.vertices;this.mesh=new MathBox.Renderable.Mesh(c,{type:"mesh",doubleSided:a.doubleSided,flipSided:a.flipSided,shaded:a.shaded,dynamic:a.live},b);this.line=new MathBox.Renderable.Mesh(c,{type:"mesh",shaded:a.shaded,dynamic:a.live,wireframe:!0},b);this.points=new MathBox.Renderable.Mesh(c.vertices,{type:"points",dynamic:a.live},b);this.calculate()},calculate:function(){var a=this.vertices,
b=this.get(),c=b.data,d=b.domain,f=b.n;"number"==typeof f&&(f=[f,f]);var e=d[0][0],h=d[1][0],g=(d[0][1]-e)/(f[0]-1),i=(d[1][1]-h)/(f[1]-1),k,j=0;_.loop(f[1],function(l){e=d[0][0];_.loop(f[0],function(d){k=c&&void 0!==c[l]&&void 0!==c[l][d]?c[l][d]:b.expression.call(this,e,h,d,l,j);k instanceof Array||(k=[e,k,h]);k=k.concat([0,0,0]);a[j].set.apply(a[j],k);e+=g;j++}.bind(this));h+=i}.bind(this))}});MathBox.Primitive.types.surface=MathBox.Surface;
MathBox.BezierSurface=function(a){this.matrixX=new THREE.Matrix4;this.matrixY=new THREE.Matrix4;this.matrixZ=new THREE.Matrix4;this.coefficients=new THREE.Matrix4(-1,3,-3,1,3,-6,3,0,-3,3,0,0,1,0,0,0);MathBox.Surface.call(this,a)};
MathBox.BezierSurface.prototype=_.extend(new MathBox.Surface(null),{defaults:function(){return{n:[64,64],domain:[[0,1],[0,1]],data:null,order:3,expression:function(){return 0},live:!1,points:!1,line:!1,mesh:!0,doubleSided:!0,flipSided:!1,shaded:!0,style:{}}},type:function(){return"bezierSurface"},calculate:function(){var a=this.vertices,b=this.get(),c=b.domain,d=b.data,f=b.order,e=b.n;"number"==typeof e&&(e=[e,e]);if(3!=f)throw"Bezier surface order must be 3.";var h=[],g;_.loop(f+1,function(a){_.loop(f+
1,function(c){g=d&&void 0!==d[a]&&void 0!==d[a][c]?d[c]:b.expression.call(this,c,a,c,a);g instanceof Array||(g=[c,g,a]);g=g.concat([0,0,0]);h.push(g)}.bind(this))}.bind(this));g=h;this.matrixX.set(g[0][0],g[1][0],g[2][0],g[3][0],g[4][0],g[5][0],g[6][0],g[7][0],g[8][0],g[9][0],g[10][0],g[11][0],g[12][0],g[13][0],g[14][0],g[15][0]);this.matrixY.set(g[0][1],g[1][1],g[2][1],g[3][1],g[4][1],g[5][1],g[6][1],g[7][1],g[8][1],g[9][1],g[10][1],g[11][1],g[12][1],g[13][1],g[14][1],g[15][1]);this.matrixZ.set(g[0][2],
g[1][2],g[2][2],g[3][2],g[4][2],g[5][2],g[6][2],g[7][2],g[8][2],g[9][2],g[10][2],g[11][2],g[12][2],g[13][2],g[14][2],g[15][2]);var i=this.coefficients;this.matrixX.multiplySelf(i).transpose().multiplySelf(i);this.matrixY.multiplySelf(i).transpose().multiplySelf(i);this.matrixZ.multiplySelf(i).transpose().multiplySelf(i);var i={bezierSurfaceX:this.matrixX,bezierSurfaceY:this.matrixY,bezierSurfaceZ:this.matrixZ},k=c[0][0],j=c[1][0],l=(c[0][1]-k)/(e[0]-1),m=(c[1][1]-j)/(e[1]-1),q=0;_.loop(e[1],function(){k=
c[0][0];_.loop(e[0],function(){a[q].set(k,j,0);k+=l;q++}.bind(this));j+=m}.bind(this));i={uniforms:i,shaders:{position:function(a,b){a.snippet("bezierSurface"+f).snippet("mathTransform");b.viewport(a)}}};this.mesh.set(i);this.line.set(i);this.points.set(i)}});MathBox.Primitive.types.bezierSurface=MathBox.BezierSurface;
MathBox.Renderable=function(a,b){if(null!==a){this.id=++MathBox.Renderable.id;var c=this.defaults();a&&(a=_.extend(c,a||{}));this.set(a||c);this.geometry=this.material=this.object=null;this.visible=!0;this.style=b||new MathBox.Style;this.style.on("change",this.styleCallback=this.refresh.bind(this));this.on("change",this.uniformsCallback=this.refresh.bind(this));this.mathTransform=new THREE.Matrix4}};MathBox.Renderable.id=0;
MathBox.Renderable.prototype={defaults:function(){return{}},make:function(){},destroy:function(){},show:function(a){this.visible=void 0===a?!0:!!a;this.refresh()},composeTransform:function(a,b,c){var d=THREE.Matrix4.__m1,f=THREE.Matrix4.__m2;d.identity();d.setRotationFromEuler(b,this.object.eulerOrder);f.makeScale(c.x,c.y,c.z);this.mathTransform.multiply(d,f);b=this.mathTransform.elements;b[12]=a.x;b[13]=a.y;b[14]=a.z},refresh:function(){var a,b=this.style.get();this.object&&(this.object.position=
b.worldPosition,this.object.rotation=b.worldRotation,this.object.scale=b.worldScale,this.composeTransform(b.mathPosition,b.mathRotation,b.mathScale),this.object.visible=this.visible&&0<b.opacity,a=this.get(),this.object.doubleSided=a.doubleSided,this.object.flipSided=a.flipSided);this.material&&(this.material.applyUniforms(b),this.material.applyUniforms({mathTransform:this.mathTransform}),(a=this.get().uniforms)&&this.material.applyUniforms(a),(a=this.get().attributes)&&this.material.applyAttributes(a))},
adjust:function(a){this.material&&this.material.applyUniforms(a.uniforms())}};MathBox.Attributes.mixin(MathBox.Renderable);MathBox.Renderable.Mesh=function(a,b,c){this.points=a;MathBox.Renderable.call(this,b,c)};
MathBox.Renderable.Mesh.prototype=_.extend(new MathBox.Renderable(null),{defaults:function(){return{type:"points",doubleSided:!0,dynamic:!1,absolute:!1,strip:!0,shaders:{}}},make:function(a){var b=this.get(),c=b.type,d=b.strip,f={points:THREE.ParticleSystem,line:THREE.Line,mesh:THREE.Mesh}[c];if(!f)throw"Invalid Mesh type '"+c+"'";var a=this.material=a.generic(b),e;e=this.points;e instanceof Array?(e=this.geometry=new THREE.Geometry,e.vertices=this.points):e=this.geometry=e;e.dynamic=b.dynamic;switch(c){case "line":b=
new THREE.Line(e,a,d?THREE.LineStrip:THREE.LinePieces);break;default:b=new f(e,a)}this.object=b;this.refresh()},adjust:function(a){this.get().dynamic&&(this.geometry.verticesNeedUpdate=!0);MathBox.Renderable.prototype.adjust.call(this,a)}});MathBox.Renderable.ArrowHead=function(a,b,c,d){this.from=a;this.to=b;MathBox.Renderable.call(this,c,d)};
MathBox.Renderable.ArrowHead.prototype=_.extend(new MathBox.Renderable(null),{defaults:function(){return{offset:0,absolute:!0,size:0.1}},adjust:function(a){var b=this.get(),c=b.offset,d=this._from.copy(this.from),f=this._to.copy(this.to);a.to(d);a.to(f);d=this.diff.sub(d,f);if(0.001>d.length())this.object.visible=!1;else{this.object.visible=!0;d=d.normalize();this.normal.x=this.diff.y+0.1;this.normal.y=this.diff.z+0.2;this.normal.z=this.diff.x+0.3;this.normal.normalize();var e=this.bi.cross(this.diff,
this.normal),h=this.normal.cross(this.diff,this.bi),b=b.size,f=(new THREE.Matrix4(e.x,d.x,h.x,f.x,e.y,d.y,h.y,f.y,e.z,d.z,h.z,f.z,0,0,0,1)).scale(new THREE.Vector3(b,b,b));this.object.updateMatrix();this.object.matrix.multiplySelf(f);f.identity().setPosition({x:0,y:0.5-c,z:0});this.object.matrix.multiplySelf(f);this.object.matrixAutoUpdate=!1;this.object.matrixWorldNeedsUpdate=!0;MathBox.Renderable.prototype.adjust.call(this,a)}},make:function(a){var b=this.get(),a=this.material=a.generic(b);this._from=
new THREE.Vector3;this._to=new THREE.Vector3;this.diff=new THREE.Vector3;this.bi=new THREE.Vector3;this.normal=new THREE.Vector3(0,0,1);b=this.geometry=new THREE.CylinderGeometry(0.33,0,1,16,1);this.object=new THREE.Mesh(b,a);this.refresh()}});MathBox.Renderable.Ticks=function(a,b,c,d,f){this.points=a;this.signs=b;this.epsilon=c;MathBox.Renderable.call(this,d,f)};
MathBox.Renderable.Ticks.prototype=_.extend(new MathBox.Renderable(null),{defaults:function(){return{dynamic:!1,absolute:!1,size:0.1}},make:function(a){var b=this.get(),c=this.points,a=this.material=a.generic({type:"line",shaders:{position:function(a,c){c.position(a,b);a.snippet("tickVertexSplit");a.group();c.viewport(a);a.next();c.viewport(a);a.combine();a.snippet("tickVertexJoin")}}}),d=this.geometry=new THREE.Geometry;d.vertices=c;this.object=new THREE.Line(d,a,THREE.LinePieces);this.refresh()},
adjust:function(a){var b=this.get();this.material&&this.material.applyAttributes({tickSign:this.signs});this.material&&this.material.applyUniforms({tickEpsilon:this.epsilon,tickSize:b.size});b.dynamic&&(this.material.attributes.tickSign.needsUpdate=!0,this.geometry.verticesNeedUpdate=!0);MathBox.Renderable.prototype.adjust.call(this,a)}});MathBox.Viewport=function(a){if(null!==a){var b=this.defaults(),a=_.extend(b,a||{});this.set(a);this.singleton="viewport";this._uniforms={}}};
MathBox.Viewport.prototype={defaults:function(){return{type:"none",rotation:[0,0,0],position:[0,0,0]}},uniforms:function(){return this._uniforms},axis:function(){return[0,1]},to:function(){},from:function(){},update:function(a){var b=this.get();_.each(["position","rotation"],function(c){a[c].set.apply(a[c],b[c])})},shader:function(a){a.snippet("mathToWorld")},validateRotation:function(a){return a.constructor==Array?(a=a.concat([0,0,0]),a.slice(0,3)):this.get("rotation")},validatePosition:function(a){return a.constructor==
Array?(a=a.concat([0,0,0]),a.slice(0,3)):this.get("position")}};MathBox.Attributes.mixin(MathBox.Viewport,"type");MathBox.Viewport.types={};MathBox.Viewport.make=function(a){return new (MathBox.Viewport.types[a.type]||MathBox.Viewport.types.cartesian||MathBox.Viewport)(a)};
MathBox.ViewportCartesian=function(a){if(null!==a){var b=MathBox.Viewport;b.call(this,a);this.super=b.prototype;this.transform=new THREE.Matrix4;this.inverse=new THREE.Matrix4;_.extend(this._uniforms,{viewportTransform:this.transform,viewportInverse:this.inverse})}};
MathBox.ViewportCartesian.prototype=_.extend(new MathBox.Viewport(null),{defaults:function(){return{type:"cartesian",range:[[-1,1],[-1,1],[-1,1]],scale:[1,1,1],rotation:[0,0,0],position:[0,0,0]}},to:function(a){this.transform.multiplyVector3(a)},from:function(a){this.inverse.multiplyVector3(a)},axis:function(a){var b=this.get().range[a],a=b[0],c=b[1],b=Math.min(a,c),a=Math.max(a,c);return[b,a]},update:function(a){var b=this.get(),c=b.range,d=b.scale,b=c[0][0],f=c[1][0],e=c[2][0],h=c[0][1]-b,g=c[1][1]-
f,c=c[2][1]-e,i=d[0],k=d[1],d=d[2],j=[h/(2*i),0,0,b+h/2,0,g/(2*k),0,f+g/2,0,0,c/(2*d),e+c/2,0,0,0,1];this.transform.set.apply(this.transform,[2*i/h,0,0,-(2*b+h)*i/h,0,2*k/g,0,-(2*f+g)*k/g,0,0,2*d/c,-(2*e+c)*d/c,0,0,0,1]);this.inverse.set.apply(this.inverse,j);MathBox.Viewport.prototype.update.call(this,a)},validateRange:function(a){for(var a=a||[],b=0;3>b;++b){a[b]=a[b]||[];for(var c=0;2>c;++c)a[b][c]=void 0!==a[b][c]?a[b][c]:2*c-1}return a},validateScale:function(a){for(var a=a||[],b=0;3>b;++b)a[b]=
a[b]||1;return a}});MathBox.Attributes.mixin(MathBox.Viewport);MathBox.Viewport.types.cartesian=MathBox.ViewportCartesian;MathBox.ViewportPolar=function(a){var b=MathBox.ViewportCartesian;b.call(this,a);this.super=b.prototype;_.extend(this._uniforms,{polarAlpha:0,polarAspect:1,polarPower:1,polarFold:1,polarFocus:1})};
MathBox.ViewportPolar.prototype=_.extend(new MathBox.ViewportCartesian(null),{defaults:function(){return{type:"polar",range:[[-1,1],[-1,1],[-1,1]],polar:1,fold:1,power:1,aspect:1,scale:[1,1,1],rotation:[0,0,0],position:[0,0,0]}},to:function(a){var b=this._uniforms.polarAspect,c=this._uniforms.polarFocus,d=this._uniforms.polarAlpha,f=this._uniforms.polarPower;a.x*=this._uniforms.polarFold;a.y=Math.sign(a.y)*Math.pow(Math.abs(a.y),f);1E-4<d&&(f=c+a.y*b,d*=a.x,a.x=Math.sin(d)*f,a.y=(Math.cos(d)*f-c)/
b);this.transform.multiplyVector3(a)},from:function(a){var b=this._uniforms.polarAspect,c=this._uniforms.polarFocus,d=this._uniforms.polarAlpha,f=this._uniforms.polarPower;this.inverse.multiplyVector3(a);if(1E-4<d){var e=a.x,h=a.y*b+c,g=Math.sqrt(e*e+h*h);theta=Math.atan2(h,e);a.x=theta/d;a.y=(g-c)/b}a.x/=options.fold;a.y=Math.sign(a.y)*Math.pow(Math.abs(a.y),1/f)},axis:function(a){var b=this.super.axis.call(this,a);min=b[0];max=b[1];alpha=this._uniforms.polarAlpha;aspect=this._uniforms.polarAspect;
focus=this._uniforms.polarFocus;1==a&&0<alpha&&(max=Math.max(Math.abs(max),Math.abs(min)),min=Math.max(-focus/aspect,min));return[min,max]},update:function(a){var b=this.get(),c=b.range,d=b.scale,f=b.polar,e=b.fold,b=b.power,h=1,g=c[0][0],i=c[1][0],k=c[2][0],j=c[0][1]-g,l=c[1][1]-i,c=c[2][1]-k,m=d[0],q=d[1],d=d[2],r=j+(l-j)*f,h=r/m/(l/q),s=[r/(2*m),0,0,g+j/2,0,l/(2*q),0,i+l/2,0,0,c/(2*d),k+c/2,0,0,0,1];this.transform.set.apply(this.transform,[2*m/r,0,0,-(2*g+j)*m/j,0,2*q/l,0,-(2*i+l)*q/l,0,0,2*d/
c,-(2*k+c)*d/c,0,0,0,1]);this.inverse.set.apply(this.inverse,s);this._uniforms.polarAlpha=f;this._uniforms.polarAspect=h;this._uniforms.polarFold=e;this._uniforms.polarPower=b;this._uniforms.polarFocus=0<f?1/f-1:0;MathBox.Viewport.prototype.update.call(this,a)},shader:function(a){a.snippet("polarPower").snippet("cartesianToPolar").snippet("mathToWorld")},validatePolar:function(a){return Math.max(0,Math.min(1,+a||0))}});MathBox.Attributes.mixin(MathBox.Viewport);MathBox.Viewport.types.polar=MathBox.ViewportPolar;
MathBox.ViewportSphere=function(a){var b=MathBox.ViewportCartesian;b.call(this,a);this.super=b.prototype;_.extend(this._uniforms,{sphereAlpha:0,sphereAspectX:1,sphereAspectY:1,sphereYScale:1,sphereFocus:1})};
MathBox.ViewportSphere.prototype=_.extend(new MathBox.ViewportCartesian(null),{defaults:function(){return{type:"sphere",range:[[-1,1],[-1,1],[-1,1]],sphere:1,aspect:1,scale:[1,1,1],rotation:[0,0,0],position:[0,0,0]}},to:function(a){var b=this._uniforms.sphereAspectX,c=this._uniforms.sphereAspectY,d=this._uniforms.sphereYScale,f=this._uniforms.sphereFocus,e=this._uniforms.sphereAlpha;if(1E-4<e){var h=f+a.z*b,g=a.x*e,d=a.y*e/c*d,e=Math.cos(d)*h;a.x=Math.sin(g)*e;a.y=Math.sin(d)*h*c;a.z=(Math.cos(g)*
e-f)/b}this.transform.multiplyVector3(a)},from:function(a){var b=this._uniforms.sphereAspectX,c=this._uniforms.sphereAspectY,d=this._uniforms.sphereYScale,f=this._uniforms.sphereFocus,e=this._uniforms.sphereAlpha;this.inverse.multiplyVector3(a);if(1E-4<e){var h=a.x,g=a.y/c,i=a.z*b+f,k=Math.sqrt(h*h+g*g+i*i);theta=Math.atan2(g,Math.sqrt(h*h+g*g));phi=Math.atan2(h,i);a.x=theta/e;a.y=phi/e*c/d;a.z=(k-f)/b}},axis:function(a){var b=this.super.axis.call(this,a);min=b[0];max=b[1];alpha=this._uniforms.sphereAlpha;
beta=this._uniforms.sphereBeta;aspectX=this._uniforms.sphereAspectX;aspectY=this._uniforms.sphereAspectY;focus=this._uniforms.sphereFocus;2==a&&0<alpha&&(max=Math.max(Math.abs(max),Math.abs(min)),min=Math.max(-focus/aspectX,min));return[min,max]},update:function(a){var b=this.get(),c=b.range,d=b.scale,b=b.sphere,f=0<b?1/b-1:0,e=c[0][0],h=c[1][0],g=c[2][0],i=c[0][1]-e,k=c[1][1]-h,c=c[2][1]-g,j=d[0],l=d[1],d=d[2],m=i+(c-i)*b,q=k+(c-k)*b,r=c/d;aspectX=m/j/r;aspectY=q/l/r/aspectX;aspectZ=2*(k/i*j/l);
yScale=Math.min(aspectY/b,1+(aspectZ-1)*b);r=[m/(2*j),0,0,e+i/2,0,q/(2*l),0,h+k/2,0,0,c/(2*d),g+c/2,0,0,0,1];this.transform.set.apply(this.transform,[2*j/m,0,0,-(2*e+i)*j/i,0,2*l/q,0,-(2*h+k)*l/k,0,0,2*d/c,-(2*g+c)*d/c,0,0,0,1]);this.inverse.set.apply(this.inverse,r);this._uniforms.sphereAlpha=b;this._uniforms.sphereAspectX=aspectX;this._uniforms.sphereAspectY=aspectY;this._uniforms.sphereYScale=yScale;this._uniforms.sphereFocus=f;MathBox.Viewport.prototype.update.call(this,a)},shader:function(a){a.snippet("cartesianToSphere").snippet("mathToWorld")},
validateSphere:function(a){return Math.max(0,Math.min(1,+a||0))}});MathBox.Attributes.mixin(MathBox.Viewport);MathBox.Viewport.types.sphere=MathBox.ViewportSphere;
